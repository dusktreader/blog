
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="http://blog.dusktreader.dev/2025/05/13/introducing-typerdrive-develop-api-connected-typer-apps-at-lightspeed/">
      
      
        <link rel="prev" href="../../../04/06/bootstrapping-python-projects-with-copier/">
      
      
        <link rel="next" href="../../../10/26/makefile-magic/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS feed" href="../../../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="../../../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.9">
    
    
      
        <title>Introducing Typerdrive: Develop API-Connected Typer Apps at Lightspeed - the.dusktreader blog</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CFira+Code:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Fira Code"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#introducing-typerdrive-develop-api-connected-typer-apps-at-lightspeed" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="the.dusktreader blog" class="md-header__button md-logo" aria-label="the.dusktreader blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            the.dusktreader blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Introducing Typerdrive: Develop API-Connected Typer Apps at Lightspeed
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="grey" data-md-color-accent="deep-orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/dusktreader/blog" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="the.dusktreader blog" class="md-nav__button md-logo" aria-label="the.dusktreader blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    the.dusktreader blog
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/dusktreader/blog" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      <a href="../../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Posts
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Archive
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2025/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2025
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Categories
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Categories
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/dev/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    dev
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../category/dev-tools/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    dev-tools
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    <span class="md-ellipsis">
      Setup
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-api" class="md-nav__link">
    <span class="md-ellipsis">
      The API
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-the-cli" class="md-nav__link">
    <span class="md-ellipsis">
      Building the CLI
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Building the CLI">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-create-the-cli-skeleton" class="md-nav__link">
    <span class="md-ellipsis">
      Step 1: Create the CLI skeleton
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 1: Create the CLI skeleton">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#initial-code" class="md-nav__link">
    <span class="md-ellipsis">
      Initial code
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-the-commands" class="md-nav__link">
    <span class="md-ellipsis">
      Running the commands
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-use-an-http-client-to-access-api-endpoints" class="md-nav__link">
    <span class="md-ellipsis">
      Step 2: Use an http client to access API endpoints
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 2: Use an http client to access API endpoints">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#updated-code" class="md-nav__link">
    <span class="md-ellipsis">
      Updated code
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-the-commands_1" class="md-nav__link">
    <span class="md-ellipsis">
      Running the commands
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-handling-errors" class="md-nav__link">
    <span class="md-ellipsis">
      Step 3: Handling errors
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 3: Handling errors">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#updated-code_1" class="md-nav__link">
    <span class="md-ellipsis">
      Updated code
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-the-commands_2" class="md-nav__link">
    <span class="md-ellipsis">
      Running the commands
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-4-add-logging" class="md-nav__link">
    <span class="md-ellipsis">
      Step 4: Add Logging
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 4: Add Logging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#updated-code_2" class="md-nav__link">
    <span class="md-ellipsis">
      Updated code
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-the-commands_3" class="md-nav__link">
    <span class="md-ellipsis">
      Running the commands
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-5-using-the-typedriveclient" class="md-nav__link">
    <span class="md-ellipsis">
      Step 5: Using the TypedriveClient
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 5: Using the TypedriveClient">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#updated-code_3" class="md-nav__link">
    <span class="md-ellipsis">
      Updated code
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-the-commands_4" class="md-nav__link">
    <span class="md-ellipsis">
      Running the commands
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-6-adding-app-settings" class="md-nav__link">
    <span class="md-ellipsis">
      Step 6: Adding app settings
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 6: Adding app settings">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#updated-code_4" class="md-nav__link">
    <span class="md-ellipsis">
      Updated code
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-the-commands_5" class="md-nav__link">
    <span class="md-ellipsis">
      Running the commands
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-7-using-the-cache" class="md-nav__link">
    <span class="md-ellipsis">
      Step 7: Using the Cache
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 7: Using the Cache">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#updated-code_5" class="md-nav__link">
    <span class="md-ellipsis">
      Updated code
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-the-commands_6" class="md-nav__link">
    <span class="md-ellipsis">
      Running the commands
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../../.." class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>
            
              <div class="md-post__authors md-typeset">
                
                  <div class="md-profile md-post__profile">
                    <span class="md-author md-author--long">
                      <img src="https://github.com/dusktreader.png" alt="Tucker Beck">
                    </span>
                    <span class="md-profile__description">
                      <strong>
                        
                          <a href="https://cv.dusktreader.dev">Tucker Beck</a>
                        
                      </strong>
                      <br>
                      Creator
                    </span>
                  </div>
                
              </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg>
                        <time datetime="2025-05-13 00:00:00+00:00" class="md-ellipsis">May 13, 2025</time>
                      </div>
                    </li>
                    
                    
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"/></svg>
                          <span class="md-ellipsis">
                            in
                            
                              <a href="../../../../category/dev/">dev</a></span>
                        </div>
                      </li>
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg>
                          <span class="md-ellipsis">
                            
                              29 min read
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
            
          </nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  


  <nav class="md-tags" >
    
      
      
      
        <span class="md-tag">Python,Typer</span>
      
    
  </nav>


  
  


<h1 id="introducing-typerdrive-develop-api-connected-typer-apps-at-lightspeed">Introducing Typerdrive: Develop API-Connected Typer Apps at Lightspeed</h1>
<div class="admonition tip">
<p class="admonition-title">TLDR</p>
<p>I created a package to extend Typer with some great features for building CLIs that communicate with APIs.</p>
</div>
<p>During my time as an engineer working primarily with Python, I've written a a fair number of CLIs powered by
<a href="https://typer.tiangolo.com" target="blank">Typer</a>. One type of project that has been popping up for me a lot lately
involves writing CLI programs that interface with RESTful APIs. These are pretty common these days with so many service
companies offering fully operational battlestations...I mean, platforms that can be accessed via API.</p>
<p>I've established some pretty useful and re-usable patterns in building these kinds of apps, and I keep finding new
ways to improve both the developer experience and the user experience. Every time I go about porting some feature
across to a new or old CLI, I wish there was a library that wrapped them all up in a nice package. Now, there is:</p>
<p><a href="https://github.com/dusktreader/typerdrive" target="blank"><img alt="typerdrive-logo" src="https://dusktreader.github.io/typerdrive/images/logo-light.png#only-light" /></a>
<a href="https://github.com/dusktreader/typerdrive" target="blank"><img alt="typerdrive-logo" src="https://dusktreader.github.io/typerdrive/images/logo-dark.png#only-dark" /></a></p>
<!-- more -->

<blockquote>
<p>She may not look like much, but she’s got it where it counts, kid. I’ve made a lot of special modifications myself.
--Han Solo</p>
</blockquote>
<p>These are the challenges I found myself facing repeatedly when building CLIs that talk to APIs:</p>
<ul>
<li><strong>Settings management</strong>: so you're not providing the same values as arguments over and over</li>
<li><strong>Cache management</strong>: to store auth tokens you use to access a secure API</li>
<li><strong>Handling errors</strong>: repackaging ugly errors and stack traces into nice user output</li>
<li><strong>Client management</strong>: serializing data into and out of your requests</li>
<li><strong>Logging management</strong>: storing and reviewing logs to diagnose errors</li>
</ul>
<p><code>typerdrive</code> wraps all this up into an interface that's easy for users and developers as well.</p>
<p>Each of these feature is fully documented in the
<a href="https://dusktreader.github.io/typerdrive/" target="blank"><code>typerdrive</code> docs</a>. There are also a full set of
<a href="https://github.com/dusktreader/typerdrive/tree/main/examples" target="blank">examples</a> and
<a href="https://dusktreader.github.io/typerdrive/demo/" target="blank">demos</a> showing how to use them. Still, I thought it
would be good to show how they could be used in actual app. I'm going to go over that with you in this walkthrough!</p>
<h2 id="setup">Setup</h2>
<p>First of all, the complete code for the "tutorial" app is available in its own github repository called
<a href="https://github.com/dusktreader/typerdrive-tutorial" target="blank">typerdrive-tutorial</a>. So, if you want to just dig
in and see how it works, you can start there.</p>
<p>I'm going to incrementally build this code as I walk through the features of <code>typerdrive</code> and how they are useful for
both users and developers.</p>
<p>This walkthrough will show you how to use <code>typerdrive</code> to build a CLI that accesses secured API endpoints. To make
this setup as easy as possible, I'm using a FastAPI instance secured with
<a href="https://omnivector-solutions.github.io/armasec/" target="blank"><code>armasec</code></a>.</p>
<div class="admonition warning">
<p class="admonition-title">Bias alert</p>
<p>I wrote <code>armasec</code>, so my opinion on how easy it is to use is probably a bit biased.</p>
</div>
<p>So, to prepare things for this app, I followed the instructions here to set up
<a href="https://auth0.com" target="blank">Auth0</a> with <code>armasec</code> as documented in
<a href="https://omnivector-solutions.github.io/armasec/tutorials/getting_started_with_auth0/" target="blank">this guide</a>.</p>
<p>To keep things lean and simple, I skipped the steps involved with setting up
<a href="https://auth0.com/docs/manage-users/access-control/rbac" target="blank">RBAC</a>. Enabling RBAC won't <em>hurt</em> anything,
but it's not necessary for this tutorial.</p>
<p>If you want to follow along on your own machine, you will need to complete the setup of an Auth0 client for yourself.
You can do this for free with Auth0.</p>
<p>If you are feeling ambitious, you could do all this with a local Keycloak instance as well by following
<a href="https://omnivector-solutions.github.io/armasec/tutorials/getting_started_with_keycloak/" target="blank">this guide</a>.
Note that the URLs used to access Keycloak are different than those for Auth0, so you will need to modify the code
provided in this walkthrough in some places.</p>
<p>OK, once you have an OIDC (Auth0 or Keycloak) provider setup, you are ready to follow along.</p>
<h2 id="the-api">The API</h2>
<p>The API itself is really basic. It has two endpoints:</p>
<ul>
<li><code>/unsecured</code>: allows access to anyone</li>
<li><code>/secured</code>: requires a logged in user</li>
</ul>
<p>The code for this API is <em>really</em> straightforward:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">api.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Depends</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">armasec</span><span class="w"> </span><span class="kn">import</span> <span class="n">Armasec</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="n">armasec</span> <span class="o">=</span> <span class="n">Armasec</span><span class="p">(</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a>    <span class="n">domain</span><span class="o">=</span><span class="s2">&quot;typerdrive-tutorial.us.auth0.com&quot;</span><span class="p">,</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a>    <span class="n">audience</span><span class="o">=</span><span class="s2">&quot;typerdrive-tutorial&quot;</span><span class="p">,</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="p">)</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10"></a>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11"></a>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/unsecured&quot;</span><span class="p">)</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">unsecured</span><span class="p">():</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Accessed unsecured endpoint!&quot;</span><span class="p">)</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15"></a>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16"></a>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/secured&quot;</span><span class="p">,</span> <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span><span class="n">Depends</span><span class="p">(</span><span class="n">armasec</span><span class="o">.</span><span class="n">lockdown</span><span class="p">())])</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">check_access</span><span class="p">():</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Accessed secured endpoint!&quot;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>If you are following along, you will have to replace the <code>Armasec</code> values for <code>domain</code> and <code>audience</code> with whatever you
selected during the Auth0 setup.</p>
<p>That's it. This FastAPI app will use <code>armasec</code> to secure the <code>/secured</code> endpoint. The <code>/unsecured</code> endpoint has no such
protection.</p>
<p>Start the API up by running:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>fastapi dev src/typerdrive_tutorial/api.py
</span></code></pre></div>
<p>This will start up a local instance of the API running on port 8000. To see the available endpoints, you can open a
browser with <code>http://localhost:8000/docs</code></p>
<p>That's it. The API is ready to receive both secured and unsecured requests. Let's test it out by hitting the unsecured
endpoint with cURL:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>$ curl -i http://localhost:8000/unsecured
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>HTTP/1.1 200 OK
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>date: Mon, 12 May 2025 16:13:08 GMT
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>server: uvicorn
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>content-length: 42
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>content-type: application/json
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>{&quot;message&quot;:&quot;Accessed unsecured endpoint!&quot;}
</span></code></pre></div>
<p>Great! The API is working. Of course, if you try to access the secured endpoint it will give you a 401 because you're
not (yet) providing an auth header:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>$ curl -i http://localhost:8000/secured
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>HTTP/1.1 401 Unauthorized
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>date: Mon, 12 May 2025 16:13:30 GMT
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>server: uvicorn
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>www-authenticate: Bearer
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>content-length: 30
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>content-type: application/json
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>{&quot;detail&quot;:&quot;Not authenticated&quot;}
</span></code></pre></div>
<p>Great! The API is ready to process requests from the CLI.</p>
<h2 id="building-the-cli">Building the CLI</h2>
<p>Now that the API is ready to go, we can start building our CLI with <code>typerdrive</code>.</p>
<h3 id="step-1-create-the-cli-skeleton">Step 1: Create the CLI skeleton</h3>
<p>In this tutorial, we will build a CLI that has two main commands:</p>
<ul>
<li><code>login</code>: Log in to Auth0 and get an access token</li>
<li><code>access</code>: Access secured or unsecured endpoints</li>
</ul>
<div class="admonition info">
<p class="admonition-title">More commands incoming</p>
<p>As we integrate <code>typerdrive</code>, more commands will <em>become</em> available, and those will be explained as we go.</p>
</div>
<h4 id="initial-code">Initial code</h4>
<p>First, we'll set up the skeleton of our API with the two commands like so:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">cli.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">typer</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typerdrive</span><span class="w"> </span><span class="kn">import</span> <span class="n">terminal_message</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="n">app</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Typer</span><span class="p">()</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">access</span><span class="p">():</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10"></a>    <span class="n">terminal_message</span><span class="p">(</span><span class="s2">&quot;Processing access command&quot;</span><span class="p">)</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11"></a>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12"></a>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">():</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15"></a>    <span class="n">terminal_message</span><span class="p">(</span><span class="s2">&quot;Processing login command&quot;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Now, this bare-bones CLI won't really do <em>anything</em>, it just prints a message for either command.</p>
<h4 id="running-the-commands">Running the commands</h4>
<p>Let's try it out:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>$ typerdrive-tutorial access
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>╭──────────────────────────────────────────────────────────────────────────────╮
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>│                                                                              │
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>│   Processing access command                                                  │
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>│                                                                              │
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>╰──────────────────────────────────────────────────────────────────────────────╯
</span></code></pre></div>
<p>The <code>terminal_message()</code> function imported from <code>typerdrive</code> just prints nicely formatted messages with
<a href="https://github.com/Textualize/rich" target="blank"><code>rich</code></a>. You can make the output much fancier, as you will see
later in this walkthrough.</p>
<h3 id="step-2-use-an-http-client-to-access-api-endpoints">Step 2: Use an http client to access API endpoints</h3>
<p>Let's start building out functionality by using an http client to access the API endpoints.</p>
<p>First, we'll use a vanilla <a href="https://www.python-httpx.org" target="blank"><code>httpx</code></a> client to issue requests to the API.</p>
<div class="admonition question">
<p class="admonition-title">Why httpx and not requests?</p>
<p>I <em>vastly</em> prefer <code>httpx</code> over <code>requests</code>; that's why this tutorial and <code>typerdrive</code> itself uses it.
<code>typerdrive</code> includes <code>httpx</code> as a dependency, so you will not need to install it separately.</p>
</div>
<h4 id="updated-code">Updated code</h4>
<p>Let's update the <code>access()</code> function like this:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">cli.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span>
<span class="normal"><a href="#__codelineno-6-13">13</a></span>
<span class="normal"><a href="#__codelineno-6-14">14</a></span>
<span class="normal"><a href="#__codelineno-6-15">15</a></span>
<span class="normal"><a href="#__codelineno-6-16">16</a></span>
<span class="normal"><a href="#__codelineno-6-17">17</a></span>
<span class="normal"><a href="#__codelineno-6-18">18</a></span>
<span class="normal"><a href="#__codelineno-6-19">19</a></span>
<span class="normal"><a href="#__codelineno-6-20">20</a></span>
<span class="normal"><a href="#__codelineno-6-21">21</a></span>
<span class="normal"><a href="#__codelineno-6-22">22</a></span>
<span class="normal"><a href="#__codelineno-6-23">23</a></span>
<span class="normal"><a href="#__codelineno-6-24">24</a></span>
<span class="normal"><a href="#__codelineno-6-25">25</a></span>
<span class="normal"><a href="#__codelineno-6-26">26</a></span>
<span class="normal"><a href="#__codelineno-6-27">27</a></span>
<span class="normal"><a href="#__codelineno-6-28">28</a></span>
<span class="normal"><a href="#__codelineno-6-29">29</a></span>
<span class="normal"><a href="#__codelineno-6-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">StrEnum</span><span class="p">,</span> <span class="n">auto</span>
</span></span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="hll"><span class="kn">import</span><span class="w"> </span><span class="nn">httpx</span>
</span></span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">typer</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typerdrive</span><span class="w"> </span><span class="kn">import</span> <span class="n">terminal_message</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6"></a>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7"></a>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="hll"><span class="k">class</span><span class="w"> </span><span class="nc">Endpoint</span><span class="p">(</span><span class="n">StrEnum</span><span class="p">):</span>
</span></span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="hll">    <span class="n">unsecured</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
</span></span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="hll">    <span class="n">secured</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
</span></span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11"></a>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12"></a>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="n">app</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Typer</span><span class="p">()</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14"></a>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15"></a>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="hll"><span class="k">def</span><span class="w"> </span><span class="nf">access</span><span class="p">(</span><span class="n">endpoint</span><span class="p">:</span> <span class="n">Endpoint</span><span class="p">):</span>
</span></span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="hll">    <span class="n">response</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;http://localhost:8000/</span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19"></a><span class="hll">    <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
</span></span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20"></a><span class="hll">    <span class="n">message</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
</span></span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="hll">    <span class="n">terminal_message</span><span class="p">(</span>
</span></span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22"></a><span class="hll">        <span class="n">message</span><span class="p">,</span>
</span></span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23"></a><span class="hll">        <span class="n">subject</span><span class="o">=</span><span class="s2">&quot;Successfully connected to API&quot;</span><span class="p">,</span>
</span></span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24"></a><span class="hll">        <span class="n">footer</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Status Code: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span></span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25"></a><span class="hll">    <span class="p">)</span>
</span></span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26"></a>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27"></a>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28"></a><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
</span><span id="__span-6-29"><a id="__codelineno-6-29" name="__codelineno-6-29"></a><span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">():</span>
</span><span id="__span-6-30"><a id="__codelineno-6-30" name="__codelineno-6-30"></a>    <span class="n">terminal_message</span><span class="p">(</span><span class="s2">&quot;Processing login command&quot;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Let's walk through what's going on here:</p>
<p>First, we add an <code>Endpoint</code> enum so that we can add a
<a href="https://typer.tiangolo.com/tutorial/arguments/" target="blank">Typer <code>argument</code></a> that controls which endpoint we
send a request to. If you run the CLI with the <code>--help</code> command, you can see that it requires you to supply either
"unsecured" or "secured" for this argument:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>$ typerdrive-tutorial access --help
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a> Usage: typerdrive-tutorial access [OPTIONS] ENDPOINT:{unsecured|secured}
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>╭─ Arguments ──────────────────────────────────────────────────────────────────╮
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>│ *    endpoint      ENDPOINT:{unsecured|secured}  [default: None] [required]  │
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>╰──────────────────────────────────────────────────────────────────────────────╯
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>╭─ Options ────────────────────────────────────────────────────────────────────╮
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>│ --help          Show this message and exit.                                  │
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>╰──────────────────────────────────────────────────────────────────────────────╯
</span></code></pre></div>
<p>The request is sent to the API via <code>httpx</code> at the chosen endpoint. Notice that we included
<code>response.raise_for_status()</code>? This will simply throw an exception if any error responses are returned. Error responses
have <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Status" target="blank">http status codes</a> in the 400
and 500 range.</p>
<p>Next, we unpack the "message" from the response payload and show it to the user with a fancier version of
<code>terminal_message()</code>.</p>
<h4 id="running-the-commands_1">Running the commands</h4>
<p>Let's try it out:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>$ typerdrive-tutorial access unsecured
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>╭─ Successfully connected to API ──────────────────────────────────────────────╮
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>│                                                                              │
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>│   API response: {&#39;message&#39;: &#39;Accessed unsecured endpoint!&#39;}                  │
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>│                                                                              │
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>╰─ Status Code: 200 ───────────────────────────────────────────────────────────╯
</span></code></pre></div>
<p>Awesome! We connected to the API and got a 200 response from the <code>/unsecured</code> endpoint. This is exactly what we wanted
to see. So, now what happens when we hit the <code>/secured</code> endpoint?</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>$ typerdrive-tutorial access secured
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>╭─────────────────── Traceback (most recent call last) ────────────────────────╮
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>│ /home/dusktreader/git-repos/personal/typerdrive-tutorial/src/typerdrive_tuto │
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>│ rial/cli.py:19 in access                                                     │
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>│                                                                              │
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>│   16 @app.command()                                                          │
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>│   17 def access(endpoint: Endpoint):                                         │
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>│   18 │   response = httpx.get(f&quot;http://localhost:8000/{endpoint}&quot;)           │
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>│ ❱ 19 │   response.raise_for_status()                                         │
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>│   20 │   message = response.json()[&quot;message&quot;]                                │
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>│   21 │   terminal_message(                                                   │
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>│   22 │   │   message,                                                        │
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>│                                                                              │
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>│ ╭───────────────── locals ─────────────────╮                                 │
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>│ │ endpoint = &lt;Endpoint.secured: &#39;secured&#39;&gt; │                                 │
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>│ │ response = &lt;Response [401 Unauthorized]&gt; │                                 │
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>│ ╰──────────────────────────────────────────╯                                 │
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>│                                                                              │
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>│ /home/dusktreader/git-repos/personal/typerdrive-tutorial/.venv/lib/python3.1 │
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>│ 3/site-packages/httpx/_models.py:829 in raise_for_status                     │
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>│                                                                              │
</span><span id="__span-9-22"><a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>│    826 │   │   }                                                             │
</span><span id="__span-9-23"><a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>│    827 │   │   error_type = error_types.get(status_class, &quot;Invalid status co │
</span><span id="__span-9-24"><a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>│    828 │   │   message = message.format(self, error_type=error_type)         │
</span><span id="__span-9-25"><a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>│ ❱  829 │   │   raise HTTPStatusError(message, request=request, response=self │
</span><span id="__span-9-26"><a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>│    830 │                                                                     │
</span><span id="__span-9-27"><a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a>│    831 │   def json(self, **kwargs: typing.Any) -&gt; typing.Any:               │
</span><span id="__span-9-28"><a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a>│    832 │   │   return jsonlib.loads(self.content, **kwargs)                  │
</span><span id="__span-9-29"><a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a>│                                                                              │
</span><span id="__span-9-30"><a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a>│ ╭─────────────────────────── locals ───────────────────────────────────────╮ │
</span><span id="__span-9-31"><a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a>│ │   error_type = &#39;Client error&#39;                                            │ │
</span><span id="__span-9-32"><a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a>│ │  error_types = {                                                         │ │
</span><span id="__span-9-33"><a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a>│ │                │   1: &#39;Informational response&#39;,                          │ │
</span><span id="__span-9-34"><a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a>│ │                │   3: &#39;Redirect response&#39;,                               │ │
</span><span id="__span-9-35"><a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a>│ │                │   4: &#39;Client error&#39;,                                    │ │
</span><span id="__span-9-36"><a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a>│ │                │   5: &#39;Server error&#39;                                     │ │
</span><span id="__span-9-37"><a id="__codelineno-9-37" name="__codelineno-9-37" href="#__codelineno-9-37"></a>│ │                }                                                         │ │
</span><span id="__span-9-38"><a id="__codelineno-9-38" name="__codelineno-9-38" href="#__codelineno-9-38"></a>│ │      message = &quot;Client error &#39;401 Unauthorized&#39; for url                  │ │
</span><span id="__span-9-39"><a id="__codelineno-9-39" name="__codelineno-9-39" href="#__codelineno-9-39"></a>│ │                &#39;http://localhost:8000/secured&#39;\nFor more&quot;+80             │ │
</span><span id="__span-9-40"><a id="__codelineno-9-40" name="__codelineno-9-40" href="#__codelineno-9-40"></a>│ │      request = &lt;Request(&#39;GET&#39;, &#39;http://localhost:8000/secured&#39;)&gt;         │ │
</span><span id="__span-9-41"><a id="__codelineno-9-41" name="__codelineno-9-41" href="#__codelineno-9-41"></a>│ │         self = &lt;Response [401 Unauthorized]&gt;                             │ │
</span><span id="__span-9-42"><a id="__codelineno-9-42" name="__codelineno-9-42" href="#__codelineno-9-42"></a>│ │ status_class = 4                                                         │ │
</span><span id="__span-9-43"><a id="__codelineno-9-43" name="__codelineno-9-43" href="#__codelineno-9-43"></a>│ ╰──────────────────────────────────────────────────────────────────────────╯ │
</span><span id="__span-9-44"><a id="__codelineno-9-44" name="__codelineno-9-44" href="#__codelineno-9-44"></a>╰──────────────────────────────────────────────────────────────────────────────╯
</span><span id="__span-9-45"><a id="__codelineno-9-45" name="__codelineno-9-45" href="#__codelineno-9-45"></a>HTTPStatusError: Client error &#39;401 Unauthorized&#39; for url
</span><span id="__span-9-46"><a id="__codelineno-9-46" name="__codelineno-9-46" href="#__codelineno-9-46"></a>&#39;http://localhost:8000/secured&#39;
</span><span id="__span-9-47"><a id="__codelineno-9-47" name="__codelineno-9-47" href="#__codelineno-9-47"></a>For more information check:
</span><span id="__span-9-48"><a id="__codelineno-9-48" name="__codelineno-9-48" href="#__codelineno-9-48"></a>https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/401
</span></code></pre></div>
<p>This should be expected. Without a valid auth token, the secured endpoint will reject the request with a
<code>401: Not Authenticated</code> response. However, this is a very unfriendly message to show to your users. That stack trace
might be super valuable to you, a developer, who needs to find out what went wrong, but it will confuse the hell out of
any enduser that's using your app.</p>
<h3 id="step-3-handling-errors">Step 3: Handling errors</h3>
<p>It can be toilsome to handle error conditions to make sure that you are providing friendlier output for the end user.
You will find yourself using the same code over and over to capture an error and re-format it nicely as well as exiting
gracefully.</p>
<p><code>typerdrive</code> provides
<a href="https://dusktreader.github.io/typerdrive/features/exceptions/" target="blank">error handling</a> that can make this much
easier for you and nice for your users as well.</p>
<h4 id="updated-code_1">Updated code</h4>
<p>Let's update the code to add error handling:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">cli.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span>
<span class="normal"><a href="#__codelineno-10-13">13</a></span>
<span class="normal"><a href="#__codelineno-10-14">14</a></span>
<span class="normal"><a href="#__codelineno-10-15">15</a></span>
<span class="normal"><a href="#__codelineno-10-16">16</a></span>
<span class="normal"><a href="#__codelineno-10-17">17</a></span>
<span class="normal"><a href="#__codelineno-10-18">18</a></span>
<span class="normal"><a href="#__codelineno-10-19">19</a></span>
<span class="normal"><a href="#__codelineno-10-20">20</a></span>
<span class="normal"><a href="#__codelineno-10-21">21</a></span>
<span class="normal"><a href="#__codelineno-10-22">22</a></span>
<span class="normal"><a href="#__codelineno-10-23">23</a></span>
<span class="normal"><a href="#__codelineno-10-24">24</a></span>
<span class="normal"><a href="#__codelineno-10-25">25</a></span>
<span class="normal"><a href="#__codelineno-10-26">26</a></span>
<span class="normal"><a href="#__codelineno-10-27">27</a></span>
<span class="normal"><a href="#__codelineno-10-28">28</a></span>
<span class="normal"><a href="#__codelineno-10-29">29</a></span>
<span class="normal"><a href="#__codelineno-10-30">30</a></span>
<span class="normal"><a href="#__codelineno-10-31">31</a></span>
<span class="normal"><a href="#__codelineno-10-32">32</a></span>
<span class="normal"><a href="#__codelineno-10-33">33</a></span>
<span class="normal"><a href="#__codelineno-10-34">34</a></span>
<span class="normal"><a href="#__codelineno-10-35">35</a></span>
<span class="normal"><a href="#__codelineno-10-36">36</a></span>
<span class="normal"><a href="#__codelineno-10-37">37</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">StrEnum</span><span class="p">,</span> <span class="n">auto</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2"></a>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">httpx</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">typer</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typerdrive</span><span class="w"> </span><span class="kn">import</span> <span class="n">terminal_message</span><span class="p">,</span> <span class="n">handle_errors</span><span class="p">,</span> <span class="n">TyperdriveError</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6"></a>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7"></a>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">Endpoint</span><span class="p">(</span><span class="n">StrEnum</span><span class="p">):</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9"></a>    <span class="n">unsecured</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10"></a>    <span class="n">secured</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11"></a>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12"></a>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13"></a><span class="hll"><span class="k">class</span><span class="w"> </span><span class="nc">TutorialError</span><span class="p">(</span><span class="n">TyperdriveError</span><span class="p">):</span>
</span></span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14"></a><span class="hll">    <span class="k">pass</span>
</span></span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15"></a>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16"></a>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17"></a><span class="n">app</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Typer</span><span class="p">()</span>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18"></a>
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19"></a>
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20"></a><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21"></a><span class="hll"><span class="nd">@handle_errors</span><span class="p">(</span><span class="s2">&quot;Failed to access the API&quot;</span><span class="p">)</span>
</span></span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22"></a><span class="k">def</span><span class="w"> </span><span class="nf">access</span><span class="p">(</span><span class="n">endpoint</span><span class="p">:</span> <span class="n">Endpoint</span><span class="p">):</span>
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;http://localhost:8000/</span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24"></a><span class="hll">    <span class="n">TutorialError</span><span class="o">.</span><span class="n">require_condition</span><span class="p">(</span>
</span></span><span id="__span-10-25"><a id="__codelineno-10-25" name="__codelineno-10-25"></a><span class="hll">        <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">,</span>
</span></span><span id="__span-10-26"><a id="__codelineno-10-26" name="__codelineno-10-26"></a><span class="hll">        <span class="sa">f</span><span class="s2">&quot;Expected status code 200, but got </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span></span><span id="__span-10-27"><a id="__codelineno-10-27" name="__codelineno-10-27"></a><span class="hll">    <span class="p">)</span>
</span></span><span id="__span-10-28"><a id="__codelineno-10-28" name="__codelineno-10-28"></a>    <span class="n">message</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
</span><span id="__span-10-29"><a id="__codelineno-10-29" name="__codelineno-10-29"></a>    <span class="n">terminal_message</span><span class="p">(</span>
</span><span id="__span-10-30"><a id="__codelineno-10-30" name="__codelineno-10-30"></a>        <span class="n">message</span><span class="p">,</span>
</span><span id="__span-10-31"><a id="__codelineno-10-31" name="__codelineno-10-31"></a>        <span class="n">subject</span><span class="o">=</span><span class="s2">&quot;Successfully connected to API&quot;</span><span class="p">,</span>
</span><span id="__span-10-32"><a id="__codelineno-10-32" name="__codelineno-10-32"></a>        <span class="n">footer</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Status Code: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="__span-10-33"><a id="__codelineno-10-33" name="__codelineno-10-33"></a>    <span class="p">)</span>
</span><span id="__span-10-34"><a id="__codelineno-10-34" name="__codelineno-10-34"></a>
</span><span id="__span-10-35"><a id="__codelineno-10-35" name="__codelineno-10-35"></a><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
</span><span id="__span-10-36"><a id="__codelineno-10-36" name="__codelineno-10-36"></a><span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">():</span>
</span><span id="__span-10-37"><a id="__codelineno-10-37" name="__codelineno-10-37"></a>    <span class="n">terminal_message</span><span class="p">(</span><span class="s2">&quot;Processing login command&quot;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Alright, let's talk through these changes. First, we are creating our own exception class. This is based off of
<code>TyperdriveError</code> which itself is a variant of a <code>Buzz</code> exception from
<a href="https://github.com/dusktreader/py-buzz" target="blank"><code>py-buzz</code></a>. By default the
<a href="https://dusktreader.github.io/typerdrive/features/exceptions/#details" target="blank"><code>@handle_errors()</code></a> decorator
will handle all <code>TyperdriveError</code> exceptions (including descendant exception classes). Instead of hitting your user with
an inscrutable stack trace and confusing error message, <code>typerdrive</code> will capture the error and provide a clear
explanation for your user.</p>
<h4 id="running-the-commands_2">Running the commands</h4>
<p>Let's try it out:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>$ typerdrive-tutorial access secured
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>╭─ Failed to access the API ───────────────────────────────────────────────────╮
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>│                                                                              │
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>│   Expected status code 200, but got 401                                      │
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>│                                                                              │
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>╰──────────────────────────────────────────────────────────────────────────────╯
</span></code></pre></div>
<p>That's much nicer for the user! Notice that the "subject" of the message is the string you passed to <code>handle_errors()</code>.
The message shown in the box will be the <code>TyperdriveError</code>'s message attribute.</p>
<p>This may be much better for the user, but for you as a maintainer it could be very hard to diagnose what went wrong.
This time, it's an obvious 401 issue, but if you were getting a 400 here you would probably want to dig into the details
a bit more.</p>
<h3 id="step-4-add-logging">Step 4: Add Logging</h3>
<p>Logging is a great way to capture details about runtime issues. Setting it up isn't necessarily hard, but it does
involve some repetetive boilerplate. <code>typerdrive</code> provides a
<a href="https://dusktreader.github.io/typerdrive/features/logging/" target="blank">logging feature</a> that makes it very easy to
set up logging so that the messages are captured on disk in a sensible place and are easy to access. It even handles
<a href="https://en.wikipedia.org/wiki/Log_rotation" target="blank">log rotation</a> to ensure that a single log file doesn't get
too large to manage.</p>
<h4 id="updated-code_2">Updated code</h4>
<p>Let's update the code to enable logging and then talk through the changes:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">cli.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span>
<span class="normal"><a href="#__codelineno-12-11">11</a></span>
<span class="normal"><a href="#__codelineno-12-12">12</a></span>
<span class="normal"><a href="#__codelineno-12-13">13</a></span>
<span class="normal"><a href="#__codelineno-12-14">14</a></span>
<span class="normal"><a href="#__codelineno-12-15">15</a></span>
<span class="normal"><a href="#__codelineno-12-16">16</a></span>
<span class="normal"><a href="#__codelineno-12-17">17</a></span>
<span class="normal"><a href="#__codelineno-12-18">18</a></span>
<span class="normal"><a href="#__codelineno-12-19">19</a></span>
<span class="normal"><a href="#__codelineno-12-20">20</a></span>
<span class="normal"><a href="#__codelineno-12-21">21</a></span>
<span class="normal"><a href="#__codelineno-12-22">22</a></span>
<span class="normal"><a href="#__codelineno-12-23">23</a></span>
<span class="normal"><a href="#__codelineno-12-24">24</a></span>
<span class="normal"><a href="#__codelineno-12-25">25</a></span>
<span class="normal"><a href="#__codelineno-12-26">26</a></span>
<span class="normal"><a href="#__codelineno-12-27">27</a></span>
<span class="normal"><a href="#__codelineno-12-28">28</a></span>
<span class="normal"><a href="#__codelineno-12-29">29</a></span>
<span class="normal"><a href="#__codelineno-12-30">30</a></span>
<span class="normal"><a href="#__codelineno-12-31">31</a></span>
<span class="normal"><a href="#__codelineno-12-32">32</a></span>
<span class="normal"><a href="#__codelineno-12-33">33</a></span>
<span class="normal"><a href="#__codelineno-12-34">34</a></span>
<span class="normal"><a href="#__codelineno-12-35">35</a></span>
<span class="normal"><a href="#__codelineno-12-36">36</a></span>
<span class="normal"><a href="#__codelineno-12-37">37</a></span>
<span class="normal"><a href="#__codelineno-12-38">38</a></span>
<span class="normal"><a href="#__codelineno-12-39">39</a></span>
<span class="normal"><a href="#__codelineno-12-40">40</a></span>
<span class="normal"><a href="#__codelineno-12-41">41</a></span>
<span class="normal"><a href="#__codelineno-12-42">42</a></span>
<span class="normal"><a href="#__codelineno-12-43">43</a></span>
<span class="normal"><a href="#__codelineno-12-44">44</a></span>
<span class="normal"><a href="#__codelineno-12-45">45</a></span>
<span class="normal"><a href="#__codelineno-12-46">46</a></span>
<span class="normal"><a href="#__codelineno-12-47">47</a></span>
<span class="normal"><a href="#__codelineno-12-48">48</a></span>
<span class="normal"><a href="#__codelineno-12-49">49</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">StrEnum</span><span class="p">,</span> <span class="n">auto</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2"></a>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">httpx</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">typer</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">loguru</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span>
</span></span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typerdrive</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7"></a>    <span class="n">TyperdriveError</span><span class="p">,</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="hll">    <span class="n">add_logs_subcommand</span><span class="p">,</span>
</span></span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="hll">    <span class="n">attach_logging</span><span class="p">,</span>
</span></span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10"></a>    <span class="n">handle_errors</span><span class="p">,</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="hll">    <span class="n">log_error</span><span class="p">,</span>
</span></span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12"></a>    <span class="n">terminal_message</span><span class="p">,</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13"></a><span class="p">)</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14"></a>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15"></a>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16"></a><span class="k">class</span><span class="w"> </span><span class="nc">Endpoint</span><span class="p">(</span><span class="n">StrEnum</span><span class="p">):</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17"></a>    <span class="n">unsecured</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18"></a>    <span class="n">secured</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19"></a>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20"></a>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21"></a><span class="k">class</span><span class="w"> </span><span class="nc">TutorialError</span><span class="p">(</span><span class="n">TyperdriveError</span><span class="p">):</span>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22"></a>    <span class="k">pass</span>
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23"></a>
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24"></a>
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25"></a><span class="n">app</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Typer</span><span class="p">()</span>
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26"></a><span class="hll"><span class="n">add_logs_subcommand</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span></span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27"></a>
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28"></a>
</span><span id="__span-12-29"><a id="__codelineno-12-29" name="__codelineno-12-29"></a><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
</span><span id="__span-12-30"><a id="__codelineno-12-30" name="__codelineno-12-30"></a><span class="nd">@handle_errors</span><span class="p">(</span><span class="s2">&quot;Failed to access the API&quot;</span><span class="p">,</span> <span class="n">do_except</span><span class="o">=</span><span class="n">log_error</span><span class="p">)</span>
</span><span id="__span-12-31"><a id="__codelineno-12-31" name="__codelineno-12-31"></a><span class="hll"><span class="nd">@attach_logging</span><span class="p">()</span>
</span></span><span id="__span-12-32"><a id="__codelineno-12-32" name="__codelineno-12-32"></a><span class="k">def</span><span class="w"> </span><span class="nf">access</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">typer</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="n">Endpoint</span><span class="p">):</span>
</span><span id="__span-12-33"><a id="__codelineno-12-33" name="__codelineno-12-33"></a><span class="hll">    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempting to access api </span><span class="si">{</span><span class="n">endpoint</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></span><span id="__span-12-34"><a id="__codelineno-12-34" name="__codelineno-12-34"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;http://localhost:8000/</span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-12-35"><a id="__codelineno-12-35" name="__codelineno-12-35"></a><span class="hll">    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Got </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></span><span id="__span-12-36"><a id="__codelineno-12-36" name="__codelineno-12-36"></a>    <span class="n">TutorialError</span><span class="o">.</span><span class="n">require_condition</span><span class="p">(</span>
</span><span id="__span-12-37"><a id="__codelineno-12-37" name="__codelineno-12-37"></a>        <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">,</span>
</span><span id="__span-12-38"><a id="__codelineno-12-38" name="__codelineno-12-38"></a>        <span class="sa">f</span><span class="s2">&quot;Expected status code 200, but got </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="__span-12-39"><a id="__codelineno-12-39" name="__codelineno-12-39"></a>    <span class="p">)</span>
</span><span id="__span-12-40"><a id="__codelineno-12-40" name="__codelineno-12-40"></a>    <span class="n">message</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
</span><span id="__span-12-41"><a id="__codelineno-12-41" name="__codelineno-12-41"></a>    <span class="n">terminal_message</span><span class="p">(</span>
</span><span id="__span-12-42"><a id="__codelineno-12-42" name="__codelineno-12-42"></a>        <span class="n">message</span><span class="p">,</span>
</span><span id="__span-12-43"><a id="__codelineno-12-43" name="__codelineno-12-43"></a>        <span class="n">subject</span><span class="o">=</span><span class="s2">&quot;Successfully connected to API&quot;</span><span class="p">,</span>
</span><span id="__span-12-44"><a id="__codelineno-12-44" name="__codelineno-12-44"></a>        <span class="n">footer</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Status Code: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="__span-12-45"><a id="__codelineno-12-45" name="__codelineno-12-45"></a>    <span class="p">)</span>
</span><span id="__span-12-46"><a id="__codelineno-12-46" name="__codelineno-12-46"></a>
</span><span id="__span-12-47"><a id="__codelineno-12-47" name="__codelineno-12-47"></a><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
</span><span id="__span-12-48"><a id="__codelineno-12-48" name="__codelineno-12-48"></a><span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">():</span>
</span><span id="__span-12-49"><a id="__codelineno-12-49" name="__codelineno-12-49"></a>    <span class="n">terminal_message</span><span class="p">(</span><span class="s2">&quot;Processing login command&quot;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>If you were to run the commands as before, you wouldn't see any effect from these changes. Logs <em>are</em> being captured,
though, and <code>typerdrive</code> can help you examine them. First, though, let's discuss the changes.</p>
<p>After initializing the Typer app, we invoke the <code>add_logs_subcommand()</code> to add additional commands for managing logs to
our app. You can examine them with the <code>--help()</code> flag:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>$ typerdrive-tutorial --help
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a> Usage: typerdrive-tutorial [OPTIONS] COMMAND [ARGS]...
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>╭─ Options ───────────────────────────────────────────────────────────────────────────────╮
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>│ --install-completion          Install completion for the current shell.                 │
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>│ --show-completion             Show completion for the current shell, to copy it or      │
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>│                               customize the installation.                               │
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>│ --help                        Show this message and exit.                               │
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>╰─────────────────────────────────────────────────────────────────────────────────────────╯
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>╭─ Commands ──────────────────────────────────────────────────────────────────────────────╮
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>│ access                                                                                  │
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>│ login                                                                                   │
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>│ logs     Manage logs for the app                                                        │
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>╰─────────────────────────────────────────────────────────────────────────────────────────╯
</span></code></pre></div>
<p>There we can see the new <code>logs</code> command, and we can dig into that deeper by running it with the <code>--help</code> flag as well:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>$ typerdrive-tutorial logs --help
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a> Usage: typerdrive-tutorial logs [OPTIONS] COMMAND [ARGS]...
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a> Manage logs for the app
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>╭─ Options ───────────────────────────────────────────────────────────────────────────────╮
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>│ --help          Show this message and exit.                                             │
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>╰─────────────────────────────────────────────────────────────────────────────────────────╯
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>╭─ Commands ──────────────────────────────────────────────────────────────────────────────╮
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>│ clear                                                                                   │
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>│ show                                                                                    │
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>│ audit                                                                                   │
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a>╰─────────────────────────────────────────────────────────────────────────────────────────╯
</span></code></pre></div>
<p>We'll dig into what these commands do in a moment, but let's return to the code changes.</p>
<p>Notice that we added a decorator for our <code>access()</code> command function called <code>@attach_logging()</code>. This enables the
logging magic added by <code>typerdrive</code> for the command function it decorates. Additionally, we added a
<code>do_except=log_error</code> argument to <code>@handle_errors()</code>. This will log the details of any handled error so we can examine
them after the fact. Finally, because <code>loguru</code> is a dependency of <code>typerdrive</code>, we can import it and use it in our
function to log our progress.</p>
<h4 id="running-the-commands_3">Running the commands</h4>
<p>Now, let's start checking out those <code>logs</code> commands. First, we'll use the <code>show</code> command to see the current log:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>$ typerdrive-tutorial logs show
</span></code></pre></div>
<p>This will immediately open the current log in your system page. The text it shows will look like this:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>2025-05-12 12:27:53.050 | DEBUG    | typerdrive.logging.attach:wrapper:42 - Logging
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>attached to typer context
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>2025-05-12 12:27:53.050 | DEBUG    | typerdrive_tutorial.cli:access:27 - Attempting to
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>access api endpoint=&lt;Endpoint.secured: &#39;secured&#39;&gt;
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>2025-05-12 12:27:53.130 | DEBUG    | typerdrive_tutorial.cli:access:29 - Got
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>response.status_code=401
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>2025-05-12 12:27:53.134 | ERROR    | typerdrive.exceptions:log_error:150 - Failed to access
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>the API -- TutorialError: Expected status code 200, but got 401
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>--------
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>Traceback:
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>  File
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>&quot;/home/dusktreader/git-repos/personal/typerdrive-tutorial/.venv/lib/python3.13/site-package
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>s/typerdrive/exceptions.py&quot;, line 85, in wrapper
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>    return_value = func(*args, **kwargs)
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>  File
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>&quot;/home/dusktreader/git-repos/personal/typerdrive-tutorial/.venv/lib/python3.13/site-package
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>s/typerdrive/logging/attach.py&quot;, line 47, in wrapper
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a>    return func(ctx, *args, **kwargs)
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a>  File
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a>&quot;/home/dusktreader/git-repos/personal/typerdrive-tutorial/src/typerdrive_tutorial/cli.py&quot;,
</span><span id="__span-16-21"><a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a>line 30, in access
</span><span id="__span-16-22"><a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a>    TutorialError.require_condition(
</span><span id="__span-16-23"><a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a>    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
</span><span id="__span-16-24"><a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a>        response.status_code == 200,
</span><span id="__span-16-25"><a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a>        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
</span><span id="__span-16-26"><a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a>        f&quot;Expected status code 200, but got {response.status_code}&quot;,
</span><span id="__span-16-27"><a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a>        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
</span><span id="__span-16-28"><a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a>    )
</span><span id="__span-16-29"><a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a>    ^
</span><span id="__span-16-30"><a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a>  File
</span><span id="__span-16-31"><a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a>&quot;/home/dusktreader/git-repos/personal/typerdrive-tutorial/.venv/lib/python3.13/site-package
</span><span id="__span-16-32"><a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a>s/buzz/base.py&quot;, line 103, in require_condition
</span><span id="__span-16-33"><a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a>    return require_condition(
</span><span id="__span-16-34"><a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a>        expr,
</span><span id="__span-16-35"><a id="__codelineno-16-35" name="__codelineno-16-35" href="#__codelineno-16-35"></a>    ...&lt;6 lines&gt;...
</span></code></pre></div>
<p>Hey, there's a stack trace like we saw before! Only now, it's hidden from your end user and waiting to be examined
through the logs subcommand. Any log lines recorded by <code>loguru</code> will be recorded here; this includes log lines from your
app as well as internal logging from <code>typerdrive</code> (as you can see in the first entry).</p>
<p>Next, let's take a look at what the <code>audit</code> subcommand does:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>$ typerdrive-tutorial logs audit
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>╭─ Current log files ──────────────────────────────────────────────────────────╮
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>│                                                                              │
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>│ 📂 /home/dusktreader/.local/share/typerdrive-tutorial/logs                   │
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>│ └── 📄 app.log (2.2 kB)                                                      │
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>│                                                                              │
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>╰─ Storing 2.2 kB in 1 files ──────────────────────────────────────────────────╯
</span></code></pre></div>
<p>You can see that this command shows you both where the logs are stored and how much disk is being used to store them. As
I mentioned earlier, <code>typerdrive</code> will automatically rotate (and compress) older log entries. By default, it will rotate
the log file once a week. Old log files are kept for a month (by default) before they are automatically removed. Both of
these behaviors can be tweaked by adjusting the
<a href="https://dusktreader.github.io/typerdrive/features/logging/#log_file_name" target="blank"><code>typerdrive</code> configuration</a>.</p>
<p>The final <code>logs</code> sub-command is <code>clear</code>. This command will delete <em>all</em> stored logging data, so use it with care!</p>
<div class="admonition note">
<p class="admonition-title">The <code>Typer.Context</code></p>
<p>You may have noticed that the code now includes an extra <code>ctx</code> parameter with type <code>TyperContext</code>. This is a device
used by Typer (and <a href="https://click.palletsprojects.com/en/stable/" target="blank"><code>Click</code></a>) to attach additional
data to the verequest context. <code>typerdrive</code> also uses it to attach its "manager" classes to the context to enable
extended behavior. You <em>must</em> include this parameter for <code>typerdrive</code> to work (currently). I'm hoping I can figure
out how to make it optional, but haven't arrived at a solution yet.</p>
</div>
<h3 id="step-5-using-the-typedriveclient">Step 5: Using the <code>TypedriveClient</code></h3>
<p>While things have been working great thus far by using <code>httpx</code> directly, <code>typderdrive</code> provides a
<a href="https://dusktreader.github.io/typerdrive/features/client/" target="blank">customized client</a> (based on httpx) that has
some nice extended functionality.</p>
<h4 id="updated-code_3">Updated code</h4>
<p>Let's switch the code over to use this <code>TyperdriveClient</code> instead of <code>httpx</code> and then talk through the changes:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">cli.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-18-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-18-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-18-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-18-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-18-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-18-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-18-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-18-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-18-10">10</a></span>
<span class="normal"><a href="#__codelineno-18-11">11</a></span>
<span class="normal"><a href="#__codelineno-18-12">12</a></span>
<span class="normal"><a href="#__codelineno-18-13">13</a></span>
<span class="normal"><a href="#__codelineno-18-14">14</a></span>
<span class="normal"><a href="#__codelineno-18-15">15</a></span>
<span class="normal"><a href="#__codelineno-18-16">16</a></span>
<span class="normal"><a href="#__codelineno-18-17">17</a></span>
<span class="normal"><a href="#__codelineno-18-18">18</a></span>
<span class="normal"><a href="#__codelineno-18-19">19</a></span>
<span class="normal"><a href="#__codelineno-18-20">20</a></span>
<span class="normal"><a href="#__codelineno-18-21">21</a></span>
<span class="normal"><a href="#__codelineno-18-22">22</a></span>
<span class="normal"><a href="#__codelineno-18-23">23</a></span>
<span class="normal"><a href="#__codelineno-18-24">24</a></span>
<span class="normal"><a href="#__codelineno-18-25">25</a></span>
<span class="normal"><a href="#__codelineno-18-26">26</a></span>
<span class="normal"><a href="#__codelineno-18-27">27</a></span>
<span class="normal"><a href="#__codelineno-18-28">28</a></span>
<span class="normal"><a href="#__codelineno-18-29">29</a></span>
<span class="normal"><a href="#__codelineno-18-30">30</a></span>
<span class="normal"><a href="#__codelineno-18-31">31</a></span>
<span class="normal"><a href="#__codelineno-18-32">32</a></span>
<span class="normal"><a href="#__codelineno-18-33">33</a></span>
<span class="normal"><a href="#__codelineno-18-34">34</a></span>
<span class="normal"><a href="#__codelineno-18-35">35</a></span>
<span class="normal"><a href="#__codelineno-18-36">36</a></span>
<span class="normal"><a href="#__codelineno-18-37">37</a></span>
<span class="normal"><a href="#__codelineno-18-38">38</a></span>
<span class="normal"><a href="#__codelineno-18-39">39</a></span>
<span class="normal"><a href="#__codelineno-18-40">40</a></span>
<span class="normal"><a href="#__codelineno-18-41">41</a></span>
<span class="normal"><a href="#__codelineno-18-42">42</a></span>
<span class="normal"><a href="#__codelineno-18-43">43</a></span>
<span class="normal"><a href="#__codelineno-18-44">44</a></span>
<span class="normal"><a href="#__codelineno-18-45">45</a></span>
<span class="normal"><a href="#__codelineno-18-46">46</a></span>
<span class="normal"><a href="#__codelineno-18-47">47</a></span>
<span class="normal"><a href="#__codelineno-18-48">48</a></span>
<span class="normal"><a href="#__codelineno-18-49">49</a></span>
<span class="normal"><a href="#__codelineno-18-50">50</a></span>
<span class="normal"><a href="#__codelineno-18-51">51</a></span>
<span class="normal"><a href="#__codelineno-18-52">52</a></span>
<span class="normal"><a href="#__codelineno-18-53">53</a></span>
<span class="normal"><a href="#__codelineno-18-54">54</a></span>
<span class="normal"><a href="#__codelineno-18-55">55</a></span>
<span class="normal"><a href="#__codelineno-18-56">56</a></span>
<span class="normal"><a href="#__codelineno-18-57">57</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">StrEnum</span><span class="p">,</span> <span class="n">auto</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">cast</span>
</span></span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3"></a>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">typer</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">loguru</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6"></a><span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
</span></span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typerdrive</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8"></a><span class="hll">    <span class="n">TyperdriveClient</span><span class="p">,</span>
</span></span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9"></a>    <span class="n">TyperdriveError</span><span class="p">,</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10"></a>    <span class="n">add_logs_subcommand</span><span class="p">,</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11"></a><span class="hll">    <span class="n">attach_client</span><span class="p">,</span>
</span></span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12"></a>    <span class="n">attach_logging</span><span class="p">,</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13"></a>    <span class="n">handle_errors</span><span class="p">,</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14"></a>    <span class="n">log_error</span><span class="p">,</span>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15"></a>    <span class="n">terminal_message</span><span class="p">,</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16"></a><span class="p">)</span>
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17"></a>
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18"></a>
</span><span id="__span-18-19"><a id="__codelineno-18-19" name="__codelineno-18-19"></a><span class="k">class</span><span class="w"> </span><span class="nc">Endpoint</span><span class="p">(</span><span class="n">StrEnum</span><span class="p">):</span>
</span><span id="__span-18-20"><a id="__codelineno-18-20" name="__codelineno-18-20"></a>    <span class="n">unsecured</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
</span><span id="__span-18-21"><a id="__codelineno-18-21" name="__codelineno-18-21"></a>    <span class="n">secured</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
</span><span id="__span-18-22"><a id="__codelineno-18-22" name="__codelineno-18-22"></a>
</span><span id="__span-18-23"><a id="__codelineno-18-23" name="__codelineno-18-23"></a>
</span><span id="__span-18-24"><a id="__codelineno-18-24" name="__codelineno-18-24"></a><span class="k">class</span><span class="w"> </span><span class="nc">TutorialError</span><span class="p">(</span><span class="n">TyperdriveError</span><span class="p">):</span>
</span><span id="__span-18-25"><a id="__codelineno-18-25" name="__codelineno-18-25"></a>    <span class="k">pass</span>
</span><span id="__span-18-26"><a id="__codelineno-18-26" name="__codelineno-18-26"></a>
</span><span id="__span-18-27"><a id="__codelineno-18-27" name="__codelineno-18-27"></a>
</span><span id="__span-18-28"><a id="__codelineno-18-28" name="__codelineno-18-28"></a><span class="hll"><span class="k">class</span><span class="w"> </span><span class="nc">APIResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span></span><span id="__span-18-29"><a id="__codelineno-18-29" name="__codelineno-18-29"></a><span class="hll">    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span id="__span-18-30"><a id="__codelineno-18-30" name="__codelineno-18-30"></a>
</span><span id="__span-18-31"><a id="__codelineno-18-31" name="__codelineno-18-31"></a>
</span><span id="__span-18-32"><a id="__codelineno-18-32" name="__codelineno-18-32"></a><span class="n">app</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Typer</span><span class="p">()</span>
</span><span id="__span-18-33"><a id="__codelineno-18-33" name="__codelineno-18-33"></a><span class="n">add_logs_subcommand</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span><span id="__span-18-34"><a id="__codelineno-18-34" name="__codelineno-18-34"></a>
</span><span id="__span-18-35"><a id="__codelineno-18-35" name="__codelineno-18-35"></a>
</span><span id="__span-18-36"><a id="__codelineno-18-36" name="__codelineno-18-36"></a><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
</span><span id="__span-18-37"><a id="__codelineno-18-37" name="__codelineno-18-37"></a><span class="nd">@handle_errors</span><span class="p">(</span><span class="s2">&quot;Failed to access the API&quot;</span><span class="p">,</span> <span class="n">do_except</span><span class="o">=</span><span class="n">log_error</span><span class="p">)</span>
</span><span id="__span-18-38"><a id="__codelineno-18-38" name="__codelineno-18-38"></a><span class="nd">@attach_logging</span><span class="p">()</span>
</span><span id="__span-18-39"><a id="__codelineno-18-39" name="__codelineno-18-39"></a><span class="hll"><span class="nd">@attach_client</span><span class="p">(</span><span class="n">api</span><span class="o">=</span><span class="s2">&quot;http://localhost:8000&quot;</span><span class="p">)</span>
</span></span><span id="__span-18-40"><a id="__codelineno-18-40" name="__codelineno-18-40"></a><span class="hll"><span class="k">def</span><span class="w"> </span><span class="nf">access</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">typer</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="n">Endpoint</span><span class="p">,</span> <span class="n">api</span><span class="p">:</span> <span class="n">TyperdriveClient</span><span class="p">):</span>
</span></span><span id="__span-18-41"><a id="__codelineno-18-41" name="__codelineno-18-41"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempting to access api </span><span class="si">{</span><span class="n">endpoint</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-18-42"><a id="__codelineno-18-42" name="__codelineno-18-42"></a><span class="hll">    <span class="n">response</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
</span></span><span id="__span-18-43"><a id="__codelineno-18-43" name="__codelineno-18-43"></a><span class="hll">        <span class="n">APIResponse</span><span class="p">,</span>
</span></span><span id="__span-18-44"><a id="__codelineno-18-44" name="__codelineno-18-44"></a><span class="hll">        <span class="n">api</span><span class="o">.</span><span class="n">get_x</span><span class="p">(</span>
</span></span><span id="__span-18-45"><a id="__codelineno-18-45" name="__codelineno-18-45"></a><span class="hll">            <span class="n">endpoint</span><span class="p">,</span>
</span></span><span id="__span-18-46"><a id="__codelineno-18-46" name="__codelineno-18-46"></a><span class="hll">            <span class="n">expected_status</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
</span></span><span id="__span-18-47"><a id="__codelineno-18-47" name="__codelineno-18-47"></a><span class="hll">            <span class="n">response_model</span><span class="o">=</span><span class="n">APIResponse</span><span class="p">,</span>
</span></span><span id="__span-18-48"><a id="__codelineno-18-48" name="__codelineno-18-48"></a><span class="hll">        <span class="p">),</span>
</span></span><span id="__span-18-49"><a id="__codelineno-18-49" name="__codelineno-18-49"></a><span class="hll">    <span class="p">)</span>
</span></span><span id="__span-18-50"><a id="__codelineno-18-50" name="__codelineno-18-50"></a>    <span class="n">terminal_message</span><span class="p">(</span>
</span><span id="__span-18-51"><a id="__codelineno-18-51" name="__codelineno-18-51"></a>        <span class="n">response</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
</span><span id="__span-18-52"><a id="__codelineno-18-52" name="__codelineno-18-52"></a>        <span class="n">subject</span><span class="o">=</span><span class="s2">&quot;Successfully connected to API&quot;</span><span class="p">,</span>
</span><span id="__span-18-53"><a id="__codelineno-18-53" name="__codelineno-18-53"></a>    <span class="p">)</span>
</span><span id="__span-18-54"><a id="__codelineno-18-54" name="__codelineno-18-54"></a>
</span><span id="__span-18-55"><a id="__codelineno-18-55" name="__codelineno-18-55"></a><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
</span><span id="__span-18-56"><a id="__codelineno-18-56" name="__codelineno-18-56"></a><span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">():</span>
</span><span id="__span-18-57"><a id="__codelineno-18-57" name="__codelineno-18-57"></a>    <span class="n">terminal_message</span><span class="p">(</span><span class="s2">&quot;Processing login command&quot;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>The first thing to note here is that we have created a new
<a href="https://docs.pydantic.dev/latest/" target="blank">Pydantic</a> model that will be used to capture the data returned
from the API. In the case of the <code>unsecured</code> endpoint, the data returned is not very complex at all. When you are
working with real, production APIs, though, the schema of responses can get quite complicated. It is really useful to be
able to deserialize a large JSON blob into Pydantic objects and validate the data at the same time. You'll see a
little more complex example of using a Pydantic model to extract an API response when we implement the <code>login</code> method.</p>
<p>Next, you should notice that we are getting an instance of a <code>TyperdriveClient</code> as a parameter to our <code>access()</code> command
function through the <code>@attach_client()</code> decorator. By providing a keyword argument we are doing two things at once:</p>
<ul>
<li>Establishing a <a href="https://www.python-httpx.org/api/#client" target="blank"><code>base_url</code></a> for the new client</li>
<li>Providing the name of the client that will be matched to a parameter of the <code>access()</code> command function.</li>
</ul>
<p>To get access to a <code>TyperdriveClient</code> in this way, you need to provide an argument to your command function with the
type <code>TyperdriveClient</code> and name that matches one provided in <code>@attach_client()</code></p>
<p>Because we've supplied a <code>base_url</code> for the client, we can give just the URL path <em>after</em> the base for our request. In
this case it is just whichever endpoint we select with the <code>endpoint</code> parameter.</p>
<p>By providing an <code>expected_status</code> argument, we are instructing the <code>TyperdriveClient</code> to <em>only</em> accept responses with
that exact status code. If any other code is receeved, a <code>ClientError</code> (derived from <code>TyperdriveError</code>) will be raised.
Our error handling will catch such an error and give a polite response to the user.</p>
<p>Finally, the <code>get_x()</code> method will deserialize the response data into an instance of the <code>response_model</code> we provided.
Although the explicit <code>cast()</code> we use here is not necessary for things to work, it helps static type checkers understand
that the value returned from the function <em>will</em> be an instance of <code>APIRespnose</code>.</p>
<h4 id="running-the-commands_4">Running the commands</h4>
<p>OK, let's try it out:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>$ typerdrive-tutorial access unsecured
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>╭─ Successfully connected to API ──────────────────────────────────────────────╮
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>│                                                                              │
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>│   Accessed unsecured endpoint!                                               │
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>│                                                                              │
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>╰──────────────────────────────────────────────────────────────────────────────╯
</span></code></pre></div>
<p>No surprises here. The request was successful, and we access the message through the <code>response</code> object.</p>
<p>Now, let's hit the <code>secured</code> endpoint:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>╭─ Failed to access the API ───────────────────────────────────────────────────╮
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>│                                                                              │
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>│   Got an unexpected status code: Expected 200, got 401 -- Unauthorized       │
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>│                                                                              │
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>╰──────────────────────────────────────────────────────────────────────────────╯
</span></code></pre></div>
<p>This time, the message is a bit different. Because the status code didn't match, we get an error message that explains
the situation nicely. If we peek at the logs (with <code>logs show</code>), we'll see some extra info logged by the client:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>2025-05-12 13:22:30.554 | DEBUG    | typerdrive_tutorial.cli:access:42 - Attempting to
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>access api endpoint=&lt;Endpoint.secured: &#39;secured&#39;&gt;
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>2025-05-12 13:22:30.554 | DEBUG    | typerdrive.client.base:request_x:26 - Processing GET
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>request to http://localhost:8000/secured
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>2025-05-12 13:22:30.554 | DEBUG    | typerdrive.client.base:request_x:53 - Issuing request
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>2025-05-12 13:22:31.212 | DEBUG    | typerdrive.client.base:request_x:57 - Checking
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>response for expected_status=200
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>2025-05-12 13:22:31.213 | ERROR    | typerdrive.exceptions:log_error:150 - Failed to access
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>the API -- ClientError: Got an unexpected status code: Expected 200, got 401 --
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>Unauthorized
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>--------
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a>Traceback:
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>  File
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a>&quot;/home/dusktreader/git-repos/personal/typerdrive-tutorial/.venv/lib/python3.13/site-package
</span><span id="__span-21-15"><a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a>s/typerdrive/exceptions.py&quot;, line 85, in wrapper
</span><span id="__span-21-16"><a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a>    return_value = func(*args, **kwargs)
</span><span id="__span-21-17"><a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a>  File
</span><span id="__span-21-18"><a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a>&quot;/home/dusktreader/git-repos/personal/typerdrive-tutorial/.venv/lib/python3.13/site-package
</span><span id="__span-21-19"><a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a>s/typerdrive/logging/attach.py&quot;, line 47, in wrapper
</span><span id="__span-21-20"><a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a>    return func(ctx, *args, **kwargs)
</span><span id="__span-21-21"><a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a>  File
</span><span id="__span-21-22"><a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a>&quot;/home/dusktreader/git-repos/personal/typerdrive-tutorial/.venv/lib/python3.13/site-package
</span><span id="__span-21-23"><a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a>s/typerdrive/client/attach.py&quot;, line 76, in wrapper
</span><span id="__span-21-24"><a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a>    return func(ctx, *args, **kwargs)
</span><span id="__span-21-25"><a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a>  File
</span><span id="__span-21-26"><a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a>&quot;/home/dusktreader/git-repos/personal/typerdrive-tutorial/src/typerdrive_tutorial/cli.py&quot;,
</span><span id="__span-21-27"><a id="__codelineno-21-27" name="__codelineno-21-27" href="#__codelineno-21-27"></a>line 45, in access
</span><span id="__span-21-28"><a id="__codelineno-21-28" name="__codelineno-21-28" href="#__codelineno-21-28"></a>    api.get_x(
</span><span id="__span-21-29"><a id="__codelineno-21-29" name="__codelineno-21-29" href="#__codelineno-21-29"></a>    ~~~~~~~~~^
</span><span id="__span-21-30"><a id="__codelineno-21-30" name="__codelineno-21-30" href="#__codelineno-21-30"></a>...
</span></code></pre></div>
<h3 id="step-6-adding-app-settings">Step 6: Adding app settings</h3>
<p>In the building stages of a new CLI app, you often don't begin development by connecting to the same API URL that your
app access in production. There may also be other ways that the URL for the API may differ throughout the lifetime of
your CLI such as region, subdomain, API versions, etc. Thus, it's usually not the best idea to have the API URL
hard-coded in your app. To allow for runtime configuration of your app for this and other purposes, <code>typerdrive</code>
provides a <a href="https://dusktreader.github.io/typerdrive/features/settings/" target="blank">settings management feature</a>
to set, adjust, and view settings values within the CLI itself.</p>
<h4 id="updated-code_4">Updated code</h4>
<p>Let's see how we can add this functionality into our app and then we'll talk through the changes:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">cli.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-22-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-22-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-22-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-22-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-22-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-22-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-22-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-22-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-22-10">10</a></span>
<span class="normal"><a href="#__codelineno-22-11">11</a></span>
<span class="normal"><a href="#__codelineno-22-12">12</a></span>
<span class="normal"><a href="#__codelineno-22-13">13</a></span>
<span class="normal"><a href="#__codelineno-22-14">14</a></span>
<span class="normal"><a href="#__codelineno-22-15">15</a></span>
<span class="normal"><a href="#__codelineno-22-16">16</a></span>
<span class="normal"><a href="#__codelineno-22-17">17</a></span>
<span class="normal"><a href="#__codelineno-22-18">18</a></span>
<span class="normal"><a href="#__codelineno-22-19">19</a></span>
<span class="normal"><a href="#__codelineno-22-20">20</a></span>
<span class="normal"><a href="#__codelineno-22-21">21</a></span>
<span class="normal"><a href="#__codelineno-22-22">22</a></span>
<span class="normal"><a href="#__codelineno-22-23">23</a></span>
<span class="normal"><a href="#__codelineno-22-24">24</a></span>
<span class="normal"><a href="#__codelineno-22-25">25</a></span>
<span class="normal"><a href="#__codelineno-22-26">26</a></span>
<span class="normal"><a href="#__codelineno-22-27">27</a></span>
<span class="normal"><a href="#__codelineno-22-28">28</a></span>
<span class="normal"><a href="#__codelineno-22-29">29</a></span>
<span class="normal"><a href="#__codelineno-22-30">30</a></span>
<span class="normal"><a href="#__codelineno-22-31">31</a></span>
<span class="normal"><a href="#__codelineno-22-32">32</a></span>
<span class="normal"><a href="#__codelineno-22-33">33</a></span>
<span class="normal"><a href="#__codelineno-22-34">34</a></span>
<span class="normal"><a href="#__codelineno-22-35">35</a></span>
<span class="normal"><a href="#__codelineno-22-36">36</a></span>
<span class="normal"><a href="#__codelineno-22-37">37</a></span>
<span class="normal"><a href="#__codelineno-22-38">38</a></span>
<span class="normal"><a href="#__codelineno-22-39">39</a></span>
<span class="normal"><a href="#__codelineno-22-40">40</a></span>
<span class="normal"><a href="#__codelineno-22-41">41</a></span>
<span class="normal"><a href="#__codelineno-22-42">42</a></span>
<span class="normal"><a href="#__codelineno-22-43">43</a></span>
<span class="normal"><a href="#__codelineno-22-44">44</a></span>
<span class="normal"><a href="#__codelineno-22-45">45</a></span>
<span class="normal"><a href="#__codelineno-22-46">46</a></span>
<span class="normal"><a href="#__codelineno-22-47">47</a></span>
<span class="normal"><a href="#__codelineno-22-48">48</a></span>
<span class="normal"><a href="#__codelineno-22-49">49</a></span>
<span class="normal"><a href="#__codelineno-22-50">50</a></span>
<span class="normal"><a href="#__codelineno-22-51">51</a></span>
<span class="normal"><a href="#__codelineno-22-52">52</a></span>
<span class="normal"><a href="#__codelineno-22-53">53</a></span>
<span class="normal"><a href="#__codelineno-22-54">54</a></span>
<span class="normal"><a href="#__codelineno-22-55">55</a></span>
<span class="normal"><a href="#__codelineno-22-56">56</a></span>
<span class="normal"><a href="#__codelineno-22-57">57</a></span>
<span class="normal"><a href="#__codelineno-22-58">58</a></span>
<span class="normal"><a href="#__codelineno-22-59">59</a></span>
<span class="normal"><a href="#__codelineno-22-60">60</a></span>
<span class="normal"><a href="#__codelineno-22-61">61</a></span>
<span class="normal"><a href="#__codelineno-22-62">62</a></span>
<span class="normal"><a href="#__codelineno-22-63">63</a></span>
<span class="normal"><a href="#__codelineno-22-64">64</a></span>
<span class="normal"><a href="#__codelineno-22-65">65</a></span>
<span class="normal"><a href="#__codelineno-22-66">66</a></span>
<span class="normal"><a href="#__codelineno-22-67">67</a></span>
<span class="normal"><a href="#__codelineno-22-68">68</a></span>
<span class="normal"><a href="#__codelineno-22-69">69</a></span>
<span class="normal"><a href="#__codelineno-22-70">70</a></span>
<span class="normal"><a href="#__codelineno-22-71">71</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">StrEnum</span><span class="p">,</span> <span class="n">auto</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">cast</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3"></a>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">typer</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">loguru</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typerdrive</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8"></a>    <span class="n">TyperdriveClient</span><span class="p">,</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9"></a>    <span class="n">TyperdriveError</span><span class="p">,</span>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10"></a>    <span class="n">add_logs_subcommand</span><span class="p">,</span>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11"></a><span class="hll">    <span class="n">add_settings_subcommand</span><span class="p">,</span>
</span></span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12"></a>    <span class="n">attach_client</span><span class="p">,</span>
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13"></a>    <span class="n">attach_logging</span><span class="p">,</span>
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14"></a><span class="hll">    <span class="n">attach_settings</span><span class="p">,</span>
</span></span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15"></a>    <span class="n">handle_errors</span><span class="p">,</span>
</span><span id="__span-22-16"><a id="__codelineno-22-16" name="__codelineno-22-16"></a>    <span class="n">log_error</span><span class="p">,</span>
</span><span id="__span-22-17"><a id="__codelineno-22-17" name="__codelineno-22-17"></a>    <span class="n">terminal_message</span><span class="p">,</span>
</span><span id="__span-22-18"><a id="__codelineno-22-18" name="__codelineno-22-18"></a><span class="p">)</span>
</span><span id="__span-22-19"><a id="__codelineno-22-19" name="__codelineno-22-19"></a>
</span><span id="__span-22-20"><a id="__codelineno-22-20" name="__codelineno-22-20"></a>
</span><span id="__span-22-21"><a id="__codelineno-22-21" name="__codelineno-22-21"></a><span class="k">class</span><span class="w"> </span><span class="nc">Endpoint</span><span class="p">(</span><span class="n">StrEnum</span><span class="p">):</span>
</span><span id="__span-22-22"><a id="__codelineno-22-22" name="__codelineno-22-22"></a>    <span class="n">unsecured</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
</span><span id="__span-22-23"><a id="__codelineno-22-23" name="__codelineno-22-23"></a>    <span class="n">secured</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
</span><span id="__span-22-24"><a id="__codelineno-22-24" name="__codelineno-22-24"></a>
</span><span id="__span-22-25"><a id="__codelineno-22-25" name="__codelineno-22-25"></a>
</span><span id="__span-22-26"><a id="__codelineno-22-26" name="__codelineno-22-26"></a><span class="hll"><span class="k">class</span><span class="w"> </span><span class="nc">Environment</span><span class="p">(</span><span class="n">StrEnum</span><span class="p">):</span>
</span></span><span id="__span-22-27"><a id="__codelineno-22-27" name="__codelineno-22-27"></a><span class="hll">    <span class="n">dev</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
</span></span><span id="__span-22-28"><a id="__codelineno-22-28" name="__codelineno-22-28"></a><span class="hll">    <span class="n">prod</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
</span></span><span id="__span-22-29"><a id="__codelineno-22-29" name="__codelineno-22-29"></a>
</span><span id="__span-22-30"><a id="__codelineno-22-30" name="__codelineno-22-30"></a>
</span><span id="__span-22-31"><a id="__codelineno-22-31" name="__codelineno-22-31"></a><span class="k">class</span><span class="w"> </span><span class="nc">TutorialError</span><span class="p">(</span><span class="n">TyperdriveError</span><span class="p">):</span>
</span><span id="__span-22-32"><a id="__codelineno-22-32" name="__codelineno-22-32"></a>    <span class="k">pass</span>
</span><span id="__span-22-33"><a id="__codelineno-22-33" name="__codelineno-22-33"></a>
</span><span id="__span-22-34"><a id="__codelineno-22-34" name="__codelineno-22-34"></a>
</span><span id="__span-22-35"><a id="__codelineno-22-35" name="__codelineno-22-35"></a><span class="k">class</span><span class="w"> </span><span class="nc">APIResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-22-36"><a id="__codelineno-22-36" name="__codelineno-22-36"></a>    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-22-37"><a id="__codelineno-22-37" name="__codelineno-22-37"></a>
</span><span id="__span-22-38"><a id="__codelineno-22-38" name="__codelineno-22-38"></a>
</span><span id="__span-22-39"><a id="__codelineno-22-39" name="__codelineno-22-39"></a><span class="hll"><span class="k">class</span><span class="w"> </span><span class="nc">Settings</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span></span><span id="__span-22-40"><a id="__codelineno-22-40" name="__codelineno-22-40"></a><span class="hll">    <span class="n">api_url</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span id="__span-22-41"><a id="__codelineno-22-41" name="__codelineno-22-41"></a><span class="hll">    <span class="n">env</span><span class="p">:</span> <span class="n">Environment</span>
</span></span><span id="__span-22-42"><a id="__codelineno-22-42" name="__codelineno-22-42"></a>
</span><span id="__span-22-43"><a id="__codelineno-22-43" name="__codelineno-22-43"></a>
</span><span id="__span-22-44"><a id="__codelineno-22-44" name="__codelineno-22-44"></a><span class="n">app</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Typer</span><span class="p">()</span>
</span><span id="__span-22-45"><a id="__codelineno-22-45" name="__codelineno-22-45"></a><span class="n">add_logs_subcommand</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span><span id="__span-22-46"><a id="__codelineno-22-46" name="__codelineno-22-46"></a><span class="hll"><span class="n">add_settings_subcommand</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">Settings</span><span class="p">)</span>
</span></span><span id="__span-22-47"><a id="__codelineno-22-47" name="__codelineno-22-47"></a>
</span><span id="__span-22-48"><a id="__codelineno-22-48" name="__codelineno-22-48"></a>
</span><span id="__span-22-49"><a id="__codelineno-22-49" name="__codelineno-22-49"></a><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
</span><span id="__span-22-50"><a id="__codelineno-22-50" name="__codelineno-22-50"></a><span class="nd">@handle_errors</span><span class="p">(</span><span class="s2">&quot;Failed to access the API&quot;</span><span class="p">,</span> <span class="n">do_except</span><span class="o">=</span><span class="n">log_error</span><span class="p">)</span>
</span><span id="__span-22-51"><a id="__codelineno-22-51" name="__codelineno-22-51"></a><span class="nd">@attach_logging</span><span class="p">()</span>
</span><span id="__span-22-52"><a id="__codelineno-22-52" name="__codelineno-22-52"></a><span class="hll"><span class="nd">@attach_settings</span><span class="p">(</span><span class="n">Settings</span><span class="p">)</span>
</span></span><span id="__span-22-53"><a id="__codelineno-22-53" name="__codelineno-22-53"></a><span class="hll"><span class="nd">@attach_client</span><span class="p">(</span><span class="n">api</span><span class="o">=</span><span class="s2">&quot;api_url&quot;</span><span class="p">)</span>
</span></span><span id="__span-22-54"><a id="__codelineno-22-54" name="__codelineno-22-54"></a><span class="hll"><span class="k">def</span><span class="w"> </span><span class="nf">access</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">typer</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="n">Endpoint</span><span class="p">,</span> <span class="n">api</span><span class="p">:</span> <span class="n">TyperdriveClient</span><span class="p">,</span> <span class="n">settings</span><span class="p">:</span> <span class="n">Settings</span><span class="p">):</span>
</span></span><span id="__span-22-55"><a id="__codelineno-22-55" name="__codelineno-22-55"></a><span class="hll">    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempting to access api </span><span class="si">{</span><span class="n">endpoint</span><span class="si">=}</span><span class="s2"> in </span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">env</span><span class="si">}</span><span class="s2"> environment&quot;</span><span class="p">)</span>
</span></span><span id="__span-22-56"><a id="__codelineno-22-56" name="__codelineno-22-56"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
</span><span id="__span-22-57"><a id="__codelineno-22-57" name="__codelineno-22-57"></a>        <span class="n">APIResponse</span><span class="p">,</span>
</span><span id="__span-22-58"><a id="__codelineno-22-58" name="__codelineno-22-58"></a>        <span class="n">api</span><span class="o">.</span><span class="n">get_x</span><span class="p">(</span>
</span><span id="__span-22-59"><a id="__codelineno-22-59" name="__codelineno-22-59"></a>            <span class="n">endpoint</span><span class="p">,</span>
</span><span id="__span-22-60"><a id="__codelineno-22-60" name="__codelineno-22-60"></a>            <span class="n">expected_status</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
</span><span id="__span-22-61"><a id="__codelineno-22-61" name="__codelineno-22-61"></a>            <span class="n">response_model</span><span class="o">=</span><span class="n">APIResponse</span><span class="p">,</span>
</span><span id="__span-22-62"><a id="__codelineno-22-62" name="__codelineno-22-62"></a>        <span class="p">),</span>
</span><span id="__span-22-63"><a id="__codelineno-22-63" name="__codelineno-22-63"></a>    <span class="p">)</span>
</span><span id="__span-22-64"><a id="__codelineno-22-64" name="__codelineno-22-64"></a>    <span class="n">terminal_message</span><span class="p">(</span>
</span><span id="__span-22-65"><a id="__codelineno-22-65" name="__codelineno-22-65"></a>        <span class="n">response</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
</span><span id="__span-22-66"><a id="__codelineno-22-66" name="__codelineno-22-66"></a>        <span class="n">subject</span><span class="o">=</span><span class="s2">&quot;Successfully connected to API&quot;</span><span class="p">,</span>
</span><span id="__span-22-67"><a id="__codelineno-22-67" name="__codelineno-22-67"></a>    <span class="p">)</span>
</span><span id="__span-22-68"><a id="__codelineno-22-68" name="__codelineno-22-68"></a>
</span><span id="__span-22-69"><a id="__codelineno-22-69" name="__codelineno-22-69"></a><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
</span><span id="__span-22-70"><a id="__codelineno-22-70" name="__codelineno-22-70"></a><span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">():</span>
</span><span id="__span-22-71"><a id="__codelineno-22-71" name="__codelineno-22-71"></a>    <span class="n">terminal_message</span><span class="p">(</span><span class="s2">&quot;Processing login command&quot;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Here you can see that we've defined a <code>Settings</code> Pydantic model that will be used to define the settings that our CLI
app needs. The model will also be used to validate the settings values that users will provide. Additionally, we defined
an <code>Environment</code> enum to let us define which environment our CLI is working in.</p>
<p>Next, we use the <code>add_settings_subcommand</code> function to add sub-commands to set, update, and manipulate the app settings.
We'll take a look at those commands shortly.</p>
<p>Finally, for the <code>access()</code> command function itself, we are going to attach the app settings using the
<code>@attach_settings()</code> decorator. This allows us to specify a parameter of type <code>Settings</code> (this must match the settings
model class that was attached) to get access to the settings in the function body. We then updated the first log line to
reflect the settings.</p>
<p>It's also notable that the value passed to <code>@attach_client()</code> for the <code>api</code> parameter was changed. <code>typerdrive</code> will
first try to find a key in the app settings to use as the <code>base_url</code> for the client. This <em>requires</em> that the
settings are already attached, so the <code>@attach_settings()</code> decorator must come first.</p>
<h4 id="running-the-commands_5">Running the commands</h4>
<p>Let's run the <code>access</code> command as-is and see what happens:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>$ typerdrive-tutorial access unsecured
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>╭─ Failed to access the API ───────────────────────────────────────────────────╮
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>│                                                                              │
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>│   Initial settings are invalid: {&#39;api_url&#39;: &#39;Field required&#39;, &#39;env&#39;:         │
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>│ &#39;Field required&#39;}                                                            │
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>│                                                                              │
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>╰──────────────────────────────────────────────────────────────────────────────╯
</span></code></pre></div>
<p>This is actually what you <em>should</em> see because we haven't actually defined any values for our settings, and we <em>must</em>
have a value for the <code>api_url</code>.</p>
<p>It's time to dig into the settings commands to resolve this. You can see the available commands with the <code>--help</code> flag:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>$ typerdrive-tutorial settings --help
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a> Usage: typerdrive-tutorial settings [OPTIONS] COMMAND [ARGS]...
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a> Manage settings for the app
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>╭─ Options ────────────────────────────────────────────────────────────────────╮
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a>│ --help          Show this message and exit.                                  │
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a>╰──────────────────────────────────────────────────────────────────────────────╯
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a>╭─ Commands ───────────────────────────────────────────────────────────────────╮
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a>│ bind                                                                         │
</span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a>│ update                                                                       │
</span><span id="__span-24-14"><a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a>│ unset                                                                        │
</span><span id="__span-24-15"><a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a>│ reset                                                                        │
</span><span id="__span-24-16"><a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a>│ show                                                                         │
</span><span id="__span-24-17"><a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a>╰──────────────────────────────────────────────────────────────────────────────╯
</span></code></pre></div>
<p>First, let's view the current settings. For this, we will use the <code>show</code> sub-command:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>$ typerdrive-tutorial settings show
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>╭─ Current settings ───────────────────────────────────────────────────────────╮
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>│                                                                              │
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>│   api-url -&gt; &lt;UNSET&gt;                                                         │
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>│       env -&gt; &lt;UNSET&gt;                                                         │
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>│                                                                              │
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>│   Settings are invalid:                                                      │
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>│   api-url -&gt; Field required                                                  │
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a>│       env -&gt; Field required                                                  │
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a>│                                                                              │
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a>╰──────────────────────────────────────────────────────────────────────────────╯
</span></code></pre></div>
<p>Before we can attach the settings to our command without error, we need to provide some values for these required
settings. To do that, let's use the <code>bind</code> sub-command. Before we issue the command, let's check how it works with
<code>--help</code>:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>$ typerdrive-tutorial settings bind --help
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a> Usage: typerdrive-tutorial settings bind [OPTIONS]
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>╭─ Options ────────────────────────────────────────────────────────────────────╮
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>│ *  --api-url        TEXT        [default: None] [required]                   │
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>│ *  --env            [dev|prod]  [default: None] [required]                   │
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>│    --help                       Show this message and exit.                  │
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a>╰──────────────────────────────────────────────────────────────────────────────╯
</span></code></pre></div>
<div class="admonition info">
<p class="admonition-title">kebab-case and snake_case</p>
<p>At this point, a detail needs to be pointed out. Notice that the settings here appear in
<a href="https://developer.mozilla.org/en-US/docs/Glossary/Kebab_case" target="blank">kebab-case</a> even though in the code
they are defined with <a href="https://developer.mozilla.org/en-US/docs/Glossary/Snake_case" target="blank">snake_case</a>.
This is due to how <code>Typer</code> coerces function arguments into CLI options which are usually kebab-case. This is a
little gotcha that you might need to watch out for!</p>
</div>
<p>Let's go ahead and define our settings using the <code>bind</code> command:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>$ typerdrive-tutorial settings bind --api-url=http://localhost:8000 --env=dev
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>╭─ Current settings ───────────────────────────────────────────────────────────╮
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>│                                                                              │
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a>│   api-url -&gt; http://localhost:8000                                           │
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>│       env -&gt; dev                                                             │
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>│                                                                              │
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>╰─ saved to /home/dusktreader/.local/share/typerdrive-tutorial/settings.json ──╯
</span></code></pre></div>
<p>Now our settings are valid! Let's go ahead and try the <code>access</code> command again to make sure that our app will use the
settings we expect:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>$ typerdrive-tutorial access unsecured
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>╭─ Successfully connected to API ──────────────────────────────────────────────╮
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>│                                                                              │
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>│   Accessed unsecured endpoint!                                               │
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>│                                                                              │
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>╰──────────────────────────────────────────────────────────────────────────────╯
</span></code></pre></div>
<p>Everything is working! Let's move on to the next <code>typerdrive</code> feature.</p>
<h3 id="step-7-using-the-cache">Step 7: Using the Cache</h3>
<p>When you're making a CLI that needs to authenticate, you really need to have some way to hang on to the auth token you
are issued between commands so that you don't have to log in every single time you run your CLI app. This is where the
cache comes in. <code>typerdrive</code> provides a <code>CacheManager</code> that can store and retrieve data from the cache. It also stores
the data in a sensible location, and gives you the ability to check what's stored in the cache as well as clear it out
if you need to.</p>
<p>After all the changes we've made, we still can't access the <code>/secured</code> endpoint. In order to get access to that secured
output we need to log in to our OIDC service, secure a token, and use it in subsequent requests to the secured endpoint.
Let's update the code to allow login and secured access.</p>
<h4 id="updated-code_5">Updated code</h4>
<p>This change introduces <em>much</em> more code, but it's really not that complicated. I'll walk you through it after I show you
the code. The source code for <code>cli.py</code> now looks like this:</p>
<div class="language-python highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">cli.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1">  1</a></span>
<span class="normal"><a href="#__codelineno-29-2">  2</a></span>
<span class="normal"><a href="#__codelineno-29-3">  3</a></span>
<span class="normal"><a href="#__codelineno-29-4">  4</a></span>
<span class="normal"><a href="#__codelineno-29-5">  5</a></span>
<span class="normal"><a href="#__codelineno-29-6">  6</a></span>
<span class="normal"><a href="#__codelineno-29-7">  7</a></span>
<span class="normal"><a href="#__codelineno-29-8">  8</a></span>
<span class="normal"><a href="#__codelineno-29-9">  9</a></span>
<span class="normal"><a href="#__codelineno-29-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-29-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-29-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-29-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-29-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-29-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-29-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-29-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-29-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-29-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-29-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-29-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-29-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-29-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-29-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-29-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-29-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-29-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-29-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-29-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-29-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-29-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-29-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-29-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-29-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-29-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-29-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-29-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-29-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-29-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-29-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-29-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-29-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-29-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-29-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-29-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-29-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-29-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-29-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-29-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-29-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-29-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-29-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-29-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-29-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-29-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-29-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-29-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-29-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-29-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-29-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-29-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-29-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-29-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-29-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-29-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-29-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-29-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-29-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-29-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-29-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-29-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-29-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-29-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-29-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-29-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-29-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-29-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-29-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-29-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-29-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-29-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-29-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-29-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-29-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-29-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-29-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-29-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-29-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-29-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-29-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-29-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-29-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-29-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-29-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-29-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-29-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-29-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-29-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-29-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-29-100">100</a></span>
<span class="normal"><a href="#__codelineno-29-101">101</a></span>
<span class="normal"><a href="#__codelineno-29-102">102</a></span>
<span class="normal"><a href="#__codelineno-29-103">103</a></span>
<span class="normal"><a href="#__codelineno-29-104">104</a></span>
<span class="normal"><a href="#__codelineno-29-105">105</a></span>
<span class="normal"><a href="#__codelineno-29-106">106</a></span>
<span class="normal"><a href="#__codelineno-29-107">107</a></span>
<span class="normal"><a href="#__codelineno-29-108">108</a></span>
<span class="normal"><a href="#__codelineno-29-109">109</a></span>
<span class="normal"><a href="#__codelineno-29-110">110</a></span>
<span class="normal"><a href="#__codelineno-29-111">111</a></span>
<span class="normal"><a href="#__codelineno-29-112">112</a></span>
<span class="normal"><a href="#__codelineno-29-113">113</a></span>
<span class="normal"><a href="#__codelineno-29-114">114</a></span>
<span class="normal"><a href="#__codelineno-29-115">115</a></span>
<span class="normal"><a href="#__codelineno-29-116">116</a></span>
<span class="normal"><a href="#__codelineno-29-117">117</a></span>
<span class="normal"><a href="#__codelineno-29-118">118</a></span>
<span class="normal"><a href="#__codelineno-29-119">119</a></span>
<span class="normal"><a href="#__codelineno-29-120">120</a></span>
<span class="normal"><a href="#__codelineno-29-121">121</a></span>
<span class="normal"><a href="#__codelineno-29-122">122</a></span>
<span class="normal"><a href="#__codelineno-29-123">123</a></span>
<span class="normal"><a href="#__codelineno-29-124">124</a></span>
<span class="normal"><a href="#__codelineno-29-125">125</a></span>
<span class="normal"><a href="#__codelineno-29-126">126</a></span>
<span class="normal"><a href="#__codelineno-29-127">127</a></span>
<span class="normal"><a href="#__codelineno-29-128">128</a></span>
<span class="normal"><a href="#__codelineno-29-129">129</a></span>
<span class="normal"><a href="#__codelineno-29-130">130</a></span>
<span class="normal"><a href="#__codelineno-29-131">131</a></span>
<span class="normal"><a href="#__codelineno-29-132">132</a></span>
<span class="normal"><a href="#__codelineno-29-133">133</a></span>
<span class="normal"><a href="#__codelineno-29-134">134</a></span>
<span class="normal"><a href="#__codelineno-29-135">135</a></span>
<span class="normal"><a href="#__codelineno-29-136">136</a></span>
<span class="normal"><a href="#__codelineno-29-137">137</a></span>
<span class="normal"><a href="#__codelineno-29-138">138</a></span>
<span class="normal"><a href="#__codelineno-29-139">139</a></span>
<span class="normal"><a href="#__codelineno-29-140">140</a></span>
<span class="normal"><a href="#__codelineno-29-141">141</a></span>
<span class="normal"><a href="#__codelineno-29-142">142</a></span>
<span class="normal"><a href="#__codelineno-29-143">143</a></span>
<span class="normal"><a href="#__codelineno-29-144">144</a></span>
<span class="normal"><a href="#__codelineno-29-145">145</a></span>
<span class="normal"><a href="#__codelineno-29-146">146</a></span>
<span class="normal"><a href="#__codelineno-29-147">147</a></span>
<span class="normal"><a href="#__codelineno-29-148">148</a></span>
<span class="normal"><a href="#__codelineno-29-149">149</a></span>
<span class="normal"><a href="#__codelineno-29-150">150</a></span>
<span class="normal"><a href="#__codelineno-29-151">151</a></span>
<span class="normal"><a href="#__codelineno-29-152">152</a></span>
<span class="normal"><a href="#__codelineno-29-153">153</a></span>
<span class="normal"><a href="#__codelineno-29-154">154</a></span>
<span class="normal"><a href="#__codelineno-29-155">155</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">StrEnum</span><span class="p">,</span> <span class="n">auto</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2"></a><span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">sleep</span>
</span></span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">cast</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4"></a>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">typer</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">loguru</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typerdrive</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9"></a><span class="hll">    <span class="n">CacheManager</span><span class="p">,</span>
</span></span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10"></a>    <span class="n">TyperdriveClient</span><span class="p">,</span>
</span><span id="__span-29-11"><a id="__codelineno-29-11" name="__codelineno-29-11"></a>    <span class="n">TyperdriveError</span><span class="p">,</span>
</span><span id="__span-29-12"><a id="__codelineno-29-12" name="__codelineno-29-12"></a><span class="hll">    <span class="n">add_cache_subcommand</span><span class="p">,</span>
</span></span><span id="__span-29-13"><a id="__codelineno-29-13" name="__codelineno-29-13"></a>    <span class="n">add_logs_subcommand</span><span class="p">,</span>
</span><span id="__span-29-14"><a id="__codelineno-29-14" name="__codelineno-29-14"></a>    <span class="n">add_settings_subcommand</span><span class="p">,</span>
</span><span id="__span-29-15"><a id="__codelineno-29-15" name="__codelineno-29-15"></a><span class="hll">    <span class="n">attach_cache</span><span class="p">,</span>
</span></span><span id="__span-29-16"><a id="__codelineno-29-16" name="__codelineno-29-16"></a>    <span class="n">attach_client</span><span class="p">,</span>
</span><span id="__span-29-17"><a id="__codelineno-29-17" name="__codelineno-29-17"></a>    <span class="n">attach_logging</span><span class="p">,</span>
</span><span id="__span-29-18"><a id="__codelineno-29-18" name="__codelineno-29-18"></a>    <span class="n">attach_settings</span><span class="p">,</span>
</span><span id="__span-29-19"><a id="__codelineno-29-19" name="__codelineno-29-19"></a>    <span class="n">handle_errors</span><span class="p">,</span>
</span><span id="__span-29-20"><a id="__codelineno-29-20" name="__codelineno-29-20"></a>    <span class="n">log_error</span><span class="p">,</span>
</span><span id="__span-29-21"><a id="__codelineno-29-21" name="__codelineno-29-21"></a>    <span class="n">terminal_message</span><span class="p">,</span>
</span><span id="__span-29-22"><a id="__codelineno-29-22" name="__codelineno-29-22"></a><span class="p">)</span>
</span><span id="__span-29-23"><a id="__codelineno-29-23" name="__codelineno-29-23"></a>
</span><span id="__span-29-24"><a id="__codelineno-29-24" name="__codelineno-29-24"></a>
</span><span id="__span-29-25"><a id="__codelineno-29-25" name="__codelineno-29-25"></a><span class="k">class</span><span class="w"> </span><span class="nc">Endpoint</span><span class="p">(</span><span class="n">StrEnum</span><span class="p">):</span>
</span><span id="__span-29-26"><a id="__codelineno-29-26" name="__codelineno-29-26"></a>    <span class="n">unsecured</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
</span><span id="__span-29-27"><a id="__codelineno-29-27" name="__codelineno-29-27"></a>    <span class="n">secured</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
</span><span id="__span-29-28"><a id="__codelineno-29-28" name="__codelineno-29-28"></a>
</span><span id="__span-29-29"><a id="__codelineno-29-29" name="__codelineno-29-29"></a>
</span><span id="__span-29-30"><a id="__codelineno-29-30" name="__codelineno-29-30"></a><span class="k">class</span><span class="w"> </span><span class="nc">Environment</span><span class="p">(</span><span class="n">StrEnum</span><span class="p">):</span>
</span><span id="__span-29-31"><a id="__codelineno-29-31" name="__codelineno-29-31"></a>    <span class="n">dev</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
</span><span id="__span-29-32"><a id="__codelineno-29-32" name="__codelineno-29-32"></a>    <span class="n">prod</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
</span><span id="__span-29-33"><a id="__codelineno-29-33" name="__codelineno-29-33"></a>
</span><span id="__span-29-34"><a id="__codelineno-29-34" name="__codelineno-29-34"></a>
</span><span id="__span-29-35"><a id="__codelineno-29-35" name="__codelineno-29-35"></a><span class="k">class</span><span class="w"> </span><span class="nc">TutorialError</span><span class="p">(</span><span class="n">TyperdriveError</span><span class="p">):</span>
</span><span id="__span-29-36"><a id="__codelineno-29-36" name="__codelineno-29-36"></a>    <span class="k">pass</span>
</span><span id="__span-29-37"><a id="__codelineno-29-37" name="__codelineno-29-37"></a>
</span><span id="__span-29-38"><a id="__codelineno-29-38" name="__codelineno-29-38"></a>
</span><span id="__span-29-39"><a id="__codelineno-29-39" name="__codelineno-29-39"></a><span class="k">class</span><span class="w"> </span><span class="nc">APIResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-29-40"><a id="__codelineno-29-40" name="__codelineno-29-40"></a>    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-29-41"><a id="__codelineno-29-41" name="__codelineno-29-41"></a>
</span><span id="__span-29-42"><a id="__codelineno-29-42" name="__codelineno-29-42"></a>
</span><span id="__span-29-43"><a id="__codelineno-29-43" name="__codelineno-29-43"></a><span class="k">class</span><span class="w"> </span><span class="nc">Settings</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-29-44"><a id="__codelineno-29-44" name="__codelineno-29-44"></a>    <span class="n">api_url</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-29-45"><a id="__codelineno-29-45" name="__codelineno-29-45"></a>    <span class="n">env</span><span class="p">:</span> <span class="n">Environment</span>
</span><span id="__span-29-46"><a id="__codelineno-29-46" name="__codelineno-29-46"></a><span class="hll">    <span class="n">auth_url</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span id="__span-29-47"><a id="__codelineno-29-47" name="__codelineno-29-47"></a><span class="hll">    <span class="n">client_id</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span id="__span-29-48"><a id="__codelineno-29-48" name="__codelineno-29-48"></a><span class="hll">    <span class="n">audience</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span id="__span-29-49"><a id="__codelineno-29-49" name="__codelineno-29-49"></a>
</span><span id="__span-29-50"><a id="__codelineno-29-50" name="__codelineno-29-50"></a>
</span><span id="__span-29-51"><a id="__codelineno-29-51" name="__codelineno-29-51"></a><span class="n">app</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Typer</span><span class="p">()</span>
</span><span id="__span-29-52"><a id="__codelineno-29-52" name="__codelineno-29-52"></a><span class="n">add_logs_subcommand</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span><span id="__span-29-53"><a id="__codelineno-29-53" name="__codelineno-29-53"></a><span class="n">add_settings_subcommand</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">Settings</span><span class="p">)</span>
</span><span id="__span-29-54"><a id="__codelineno-29-54" name="__codelineno-29-54"></a><span class="hll"><span class="n">add_cache_subcommand</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span></span><span id="__span-29-55"><a id="__codelineno-29-55" name="__codelineno-29-55"></a>
</span><span id="__span-29-56"><a id="__codelineno-29-56" name="__codelineno-29-56"></a>
</span><span id="__span-29-57"><a id="__codelineno-29-57" name="__codelineno-29-57"></a><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
</span><span id="__span-29-58"><a id="__codelineno-29-58" name="__codelineno-29-58"></a><span class="nd">@handle_errors</span><span class="p">(</span><span class="s2">&quot;Failed to access the API&quot;</span><span class="p">,</span> <span class="n">do_except</span><span class="o">=</span><span class="n">log_error</span><span class="p">)</span>
</span><span id="__span-29-59"><a id="__codelineno-29-59" name="__codelineno-29-59"></a><span class="nd">@attach_logging</span><span class="p">()</span>
</span><span id="__span-29-60"><a id="__codelineno-29-60" name="__codelineno-29-60"></a><span class="nd">@attach_settings</span><span class="p">(</span><span class="n">Settings</span><span class="p">)</span>
</span><span id="__span-29-61"><a id="__codelineno-29-61" name="__codelineno-29-61"></a><span class="nd">@attach_client</span><span class="p">(</span><span class="n">api</span><span class="o">=</span><span class="s2">&quot;api_url&quot;</span><span class="p">)</span>
</span><span id="__span-29-62"><a id="__codelineno-29-62" name="__codelineno-29-62"></a><span class="hll"><span class="nd">@attach_cache</span><span class="p">()</span>
</span></span><span id="__span-29-63"><a id="__codelineno-29-63" name="__codelineno-29-63"></a><span class="hll"><span class="k">def</span><span class="w"> </span><span class="nf">access</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">typer</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="n">Endpoint</span><span class="p">,</span> <span class="n">api</span><span class="p">:</span> <span class="n">TyperdriveClient</span><span class="p">,</span> <span class="n">settings</span><span class="p">:</span> <span class="n">Settings</span><span class="p">,</span> <span class="n">cache</span><span class="p">:</span> <span class="n">CacheManager</span><span class="p">):</span>
</span></span><span id="__span-29-64"><a id="__codelineno-29-64" name="__codelineno-29-64"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempting to access api </span><span class="si">{</span><span class="n">endpoint</span><span class="si">=}</span><span class="s2"> in </span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">env</span><span class="si">}</span><span class="s2"> environment&quot;</span><span class="p">)</span>
</span><span id="__span-29-65"><a id="__codelineno-29-65" name="__codelineno-29-65"></a><span class="hll">    <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span id="__span-29-66"><a id="__codelineno-29-66" name="__codelineno-29-66"></a><span class="hll">    <span class="k">if</span> <span class="n">endpoint</span> <span class="o">==</span> <span class="n">Endpoint</span><span class="o">.</span><span class="n">secured</span><span class="p">:</span>
</span></span><span id="__span-29-67"><a id="__codelineno-29-67" name="__codelineno-29-67"></a><span class="hll">        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading access token from cache&quot;</span><span class="p">)</span>
</span></span><span id="__span-29-68"><a id="__codelineno-29-68" name="__codelineno-29-68"></a><span class="hll">        <span class="n">access_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">load_text</span><span class="p">(</span><span class="s2">&quot;auth/access.token&quot;</span><span class="p">)</span>
</span></span><span id="__span-29-69"><a id="__codelineno-29-69" name="__codelineno-29-69"></a><span class="hll">        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">access_token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
</span></span><span id="__span-29-70"><a id="__codelineno-29-70" name="__codelineno-29-70"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
</span><span id="__span-29-71"><a id="__codelineno-29-71" name="__codelineno-29-71"></a>        <span class="n">APIResponse</span><span class="p">,</span>
</span><span id="__span-29-72"><a id="__codelineno-29-72" name="__codelineno-29-72"></a>        <span class="n">api</span><span class="o">.</span><span class="n">get_x</span><span class="p">(</span>
</span><span id="__span-29-73"><a id="__codelineno-29-73" name="__codelineno-29-73"></a>            <span class="n">endpoint</span><span class="p">,</span>
</span><span id="__span-29-74"><a id="__codelineno-29-74" name="__codelineno-29-74"></a>            <span class="n">expected_status</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
</span><span id="__span-29-75"><a id="__codelineno-29-75" name="__codelineno-29-75"></a>            <span class="n">response_model</span><span class="o">=</span><span class="n">APIResponse</span><span class="p">,</span>
</span><span id="__span-29-76"><a id="__codelineno-29-76" name="__codelineno-29-76"></a>            <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
</span><span id="__span-29-77"><a id="__codelineno-29-77" name="__codelineno-29-77"></a>        <span class="p">),</span>
</span><span id="__span-29-78"><a id="__codelineno-29-78" name="__codelineno-29-78"></a>    <span class="p">)</span>
</span><span id="__span-29-79"><a id="__codelineno-29-79" name="__codelineno-29-79"></a>    <span class="n">terminal_message</span><span class="p">(</span>
</span><span id="__span-29-80"><a id="__codelineno-29-80" name="__codelineno-29-80"></a>        <span class="n">response</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
</span><span id="__span-29-81"><a id="__codelineno-29-81" name="__codelineno-29-81"></a>        <span class="n">subject</span><span class="o">=</span><span class="s2">&quot;Successfully connected to API&quot;</span><span class="p">,</span>
</span><span id="__span-29-82"><a id="__codelineno-29-82" name="__codelineno-29-82"></a>    <span class="p">)</span>
</span><span id="__span-29-83"><a id="__codelineno-29-83" name="__codelineno-29-83"></a>
</span><span id="__span-29-84"><a id="__codelineno-29-84" name="__codelineno-29-84"></a>
</span><span id="__span-29-85"><a id="__codelineno-29-85" name="__codelineno-29-85"></a><span class="hll"><span class="k">class</span><span class="w"> </span><span class="nc">LoginRequestData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span></span><span id="__span-29-86"><a id="__codelineno-29-86" name="__codelineno-29-86"></a><span class="hll">    <span class="n">client_id</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span id="__span-29-87"><a id="__codelineno-29-87" name="__codelineno-29-87"></a><span class="hll">    <span class="n">grant_type</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span id="__span-29-88"><a id="__codelineno-29-88" name="__codelineno-29-88"></a><span class="hll">    <span class="n">audience</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span id="__span-29-89"><a id="__codelineno-29-89" name="__codelineno-29-89"></a><span class="hll">
</span></span><span id="__span-29-90"><a id="__codelineno-29-90" name="__codelineno-29-90"></a><span class="hll">
</span></span><span id="__span-29-91"><a id="__codelineno-29-91" name="__codelineno-29-91"></a><span class="hll"><span class="k">class</span><span class="w"> </span><span class="nc">TokenRequestData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span></span><span id="__span-29-92"><a id="__codelineno-29-92" name="__codelineno-29-92"></a><span class="hll">    <span class="n">grant_type</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span id="__span-29-93"><a id="__codelineno-29-93" name="__codelineno-29-93"></a><span class="hll">    <span class="n">device_code</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span id="__span-29-94"><a id="__codelineno-29-94" name="__codelineno-29-94"></a><span class="hll">    <span class="n">client_id</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span id="__span-29-95"><a id="__codelineno-29-95" name="__codelineno-29-95"></a><span class="hll">
</span></span><span id="__span-29-96"><a id="__codelineno-29-96" name="__codelineno-29-96"></a><span class="hll">
</span></span><span id="__span-29-97"><a id="__codelineno-29-97" name="__codelineno-29-97"></a><span class="hll"><span class="k">class</span><span class="w"> </span><span class="nc">DeviceCodeData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span></span><span id="__span-29-98"><a id="__codelineno-29-98" name="__codelineno-29-98"></a><span class="hll">    <span class="n">device_code</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span id="__span-29-99"><a id="__codelineno-29-99" name="__codelineno-29-99"></a><span class="hll">    <span class="n">verification_uri_complete</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span id="__span-29-100"><a id="__codelineno-29-100" name="__codelineno-29-100"></a><span class="hll">    <span class="n">interval</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span id="__span-29-101"><a id="__codelineno-29-101" name="__codelineno-29-101"></a><span class="hll">
</span></span><span id="__span-29-102"><a id="__codelineno-29-102" name="__codelineno-29-102"></a><span class="hll">
</span></span><span id="__span-29-103"><a id="__codelineno-29-103" name="__codelineno-29-103"></a><span class="hll"><span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
</span></span><span id="__span-29-104"><a id="__codelineno-29-104" name="__codelineno-29-104"></a><span class="hll"><span class="nd">@handle_errors</span><span class="p">(</span><span class="s2">&quot;Login failed&quot;</span><span class="p">)</span>
</span></span><span id="__span-29-105"><a id="__codelineno-29-105" name="__codelineno-29-105"></a><span class="hll"><span class="nd">@attach_logging</span><span class="p">()</span>
</span></span><span id="__span-29-106"><a id="__codelineno-29-106" name="__codelineno-29-106"></a><span class="hll"><span class="nd">@attach_settings</span><span class="p">(</span><span class="n">Settings</span><span class="p">)</span>
</span></span><span id="__span-29-107"><a id="__codelineno-29-107" name="__codelineno-29-107"></a><span class="hll"><span class="nd">@attach_cache</span><span class="p">()</span>
</span></span><span id="__span-29-108"><a id="__codelineno-29-108" name="__codelineno-29-108"></a><span class="hll"><span class="nd">@attach_client</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="s2">&quot;auth_url&quot;</span><span class="p">)</span>
</span></span><span id="__span-29-109"><a id="__codelineno-29-109" name="__codelineno-29-109"></a><span class="hll"><span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">typer</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">settings</span><span class="p">:</span> <span class="n">Settings</span><span class="p">,</span> <span class="n">auth</span><span class="p">:</span> <span class="n">TyperdriveClient</span><span class="p">,</span> <span class="n">cache</span><span class="p">:</span> <span class="n">CacheManager</span><span class="p">):</span>
</span></span><span id="__span-29-110"><a id="__codelineno-29-110" name="__codelineno-29-110"></a><span class="hll">    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Starting login process&quot;</span><span class="p">)</span>
</span></span><span id="__span-29-111"><a id="__codelineno-29-111" name="__codelineno-29-111"></a><span class="hll">    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requesting device code from auth provider&quot;</span><span class="p">)</span>
</span></span><span id="__span-29-112"><a id="__codelineno-29-112" name="__codelineno-29-112"></a><span class="hll">    <span class="n">device_code_data</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
</span></span><span id="__span-29-113"><a id="__codelineno-29-113" name="__codelineno-29-113"></a><span class="hll">        <span class="n">DeviceCodeData</span><span class="p">,</span>
</span></span><span id="__span-29-114"><a id="__codelineno-29-114" name="__codelineno-29-114"></a><span class="hll">        <span class="n">auth</span><span class="o">.</span><span class="n">post_x</span><span class="p">(</span>
</span></span><span id="__span-29-115"><a id="__codelineno-29-115" name="__codelineno-29-115"></a><span class="hll">            <span class="s2">&quot;/oauth/device/code&quot;</span><span class="p">,</span>
</span></span><span id="__span-29-116"><a id="__codelineno-29-116" name="__codelineno-29-116"></a><span class="hll">            <span class="n">expected_status</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
</span></span><span id="__span-29-117"><a id="__codelineno-29-117" name="__codelineno-29-117"></a><span class="hll">            <span class="n">body_obj</span><span class="o">=</span><span class="n">LoginRequestData</span><span class="p">(</span>
</span></span><span id="__span-29-118"><a id="__codelineno-29-118" name="__codelineno-29-118"></a><span class="hll">                <span class="n">client_id</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">client_id</span><span class="p">,</span>
</span></span><span id="__span-29-119"><a id="__codelineno-29-119" name="__codelineno-29-119"></a><span class="hll">                <span class="n">grant_type</span><span class="o">=</span><span class="s2">&quot;client_credentials&quot;</span><span class="p">,</span>
</span></span><span id="__span-29-120"><a id="__codelineno-29-120" name="__codelineno-29-120"></a><span class="hll">                <span class="n">audience</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">audience</span><span class="p">,</span>
</span></span><span id="__span-29-121"><a id="__codelineno-29-121" name="__codelineno-29-121"></a><span class="hll">            <span class="p">),</span>
</span></span><span id="__span-29-122"><a id="__codelineno-29-122" name="__codelineno-29-122"></a><span class="hll">            <span class="n">response_model</span><span class="o">=</span><span class="n">DeviceCodeData</span><span class="p">,</span>
</span></span><span id="__span-29-123"><a id="__codelineno-29-123" name="__codelineno-29-123"></a><span class="hll">        <span class="p">),</span>
</span></span><span id="__span-29-124"><a id="__codelineno-29-124" name="__codelineno-29-124"></a><span class="hll">    <span class="p">)</span>
</span></span><span id="__span-29-125"><a id="__codelineno-29-125" name="__codelineno-29-125"></a><span class="hll">    <span class="n">terminal_message</span><span class="p">(</span>
</span></span><span id="__span-29-126"><a id="__codelineno-29-126" name="__codelineno-29-126"></a><span class="hll">        <span class="sa">f</span><span class="s2">&quot;Open </span><span class="si">{</span><span class="n">device_code_data</span><span class="o">.</span><span class="n">verification_uri_complete</span><span class="si">}</span><span class="s2"> in a browser to complete login&quot;</span><span class="p">,</span>
</span></span><span id="__span-29-127"><a id="__codelineno-29-127" name="__codelineno-29-127"></a><span class="hll">        <span class="n">subject</span><span class="o">=</span><span class="s2">&quot;Complete login with browser&quot;</span><span class="p">,</span>
</span></span><span id="__span-29-128"><a id="__codelineno-29-128" name="__codelineno-29-128"></a><span class="hll">    <span class="p">)</span>
</span></span><span id="__span-29-129"><a id="__codelineno-29-129" name="__codelineno-29-129"></a><span class="hll">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span id="__span-29-130"><a id="__codelineno-29-130" name="__codelineno-29-130"></a><span class="hll">        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Attempting to retrieve a token&quot;</span><span class="p">)</span>
</span></span><span id="__span-29-131"><a id="__codelineno-29-131" name="__codelineno-29-131"></a><span class="hll">        <span class="n">response_data</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
</span></span><span id="__span-29-132"><a id="__codelineno-29-132" name="__codelineno-29-132"></a><span class="hll">            <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
</span></span><span id="__span-29-133"><a id="__codelineno-29-133" name="__codelineno-29-133"></a><span class="hll">            <span class="n">auth</span><span class="o">.</span><span class="n">post_x</span><span class="p">(</span>
</span></span><span id="__span-29-134"><a id="__codelineno-29-134" name="__codelineno-29-134"></a><span class="hll">                <span class="s2">&quot;/oauth/token&quot;</span><span class="p">,</span>
</span></span><span id="__span-29-135"><a id="__codelineno-29-135" name="__codelineno-29-135"></a><span class="hll">                <span class="n">body_obj</span><span class="o">=</span><span class="n">TokenRequestData</span><span class="p">(</span>
</span></span><span id="__span-29-136"><a id="__codelineno-29-136" name="__codelineno-29-136"></a><span class="hll">                    <span class="n">grant_type</span><span class="o">=</span><span class="s2">&quot;urn:ietf:params:oauth:grant-type:device_code&quot;</span><span class="p">,</span>
</span></span><span id="__span-29-137"><a id="__codelineno-29-137" name="__codelineno-29-137"></a><span class="hll">                    <span class="n">device_code</span><span class="o">=</span><span class="n">device_code_data</span><span class="o">.</span><span class="n">device_code</span><span class="p">,</span>
</span></span><span id="__span-29-138"><a id="__codelineno-29-138" name="__codelineno-29-138"></a><span class="hll">                    <span class="n">client_id</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">client_id</span><span class="p">,</span>
</span></span><span id="__span-29-139"><a id="__codelineno-29-139" name="__codelineno-29-139"></a><span class="hll">                <span class="p">),</span>
</span></span><span id="__span-29-140"><a id="__codelineno-29-140" name="__codelineno-29-140"></a><span class="hll">            <span class="p">),</span>
</span></span><span id="__span-29-141"><a id="__codelineno-29-141" name="__codelineno-29-141"></a><span class="hll">        <span class="p">)</span>
</span></span><span id="__span-29-142"><a id="__codelineno-29-142" name="__codelineno-29-142"></a><span class="hll">        <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">response_data</span><span class="p">:</span>
</span></span><span id="__span-29-143"><a id="__codelineno-29-143" name="__codelineno-29-143"></a><span class="hll">            <span class="n">TutorialError</span><span class="o">.</span><span class="n">require_condition</span><span class="p">(</span>
</span></span><span id="__span-29-144"><a id="__codelineno-29-144" name="__codelineno-29-144"></a><span class="hll">                <span class="n">response_data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;authorization_pending&quot;</span><span class="p">,</span>
</span></span><span id="__span-29-145"><a id="__codelineno-29-145" name="__codelineno-29-145"></a><span class="hll">                <span class="sa">f</span><span class="s2">&quot;Failed to fetch a token with device_code </span><span class="si">{</span><span class="n">device_code_data</span><span class="o">.</span><span class="n">device_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span></span><span id="__span-29-146"><a id="__codelineno-29-146" name="__codelineno-29-146"></a><span class="hll">            <span class="p">)</span>
</span></span><span id="__span-29-147"><a id="__codelineno-29-147" name="__codelineno-29-147"></a><span class="hll">            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Didn&#39;t get a token yet. Trying again in </span><span class="si">{</span><span class="n">device_code_data</span><span class="o">.</span><span class="n">interval</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</span></span><span id="__span-29-148"><a id="__codelineno-29-148" name="__codelineno-29-148"></a><span class="hll">            <span class="n">sleep</span><span class="p">(</span><span class="n">device_code_data</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span>
</span></span><span id="__span-29-149"><a id="__codelineno-29-149" name="__codelineno-29-149"></a><span class="hll">        <span class="k">else</span><span class="p">:</span>
</span></span><span id="__span-29-150"><a id="__codelineno-29-150" name="__codelineno-29-150"></a><span class="hll">            <span class="k">with</span> <span class="n">TutorialError</span><span class="o">.</span><span class="n">handle_errors</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t extract token from response&quot;</span><span class="p">):</span>
</span></span><span id="__span-29-151"><a id="__codelineno-29-151" name="__codelineno-29-151"></a><span class="hll">                <span class="n">access_token</span> <span class="o">=</span> <span class="n">response_data</span><span class="p">[</span><span class="s2">&quot;access_token&quot;</span><span class="p">]</span>
</span></span><span id="__span-29-152"><a id="__codelineno-29-152" name="__codelineno-29-152"></a><span class="hll">            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received access token </span><span class="si">{</span><span class="n">access_token</span><span class="p">[:</span><span class="mi">32</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</span></span><span id="__span-29-153"><a id="__codelineno-29-153" name="__codelineno-29-153"></a><span class="hll">            <span class="n">cache</span><span class="o">.</span><span class="n">store_text</span><span class="p">(</span><span class="n">access_token</span><span class="p">,</span> <span class="s2">&quot;auth/access.token&quot;</span><span class="p">)</span>
</span></span><span id="__span-29-154"><a id="__codelineno-29-154" name="__codelineno-29-154"></a><span class="hll">            <span class="k">break</span>
</span></span><span id="__span-29-155"><a id="__codelineno-29-155" name="__codelineno-29-155"></a><span class="hll">    <span class="n">terminal_message</span><span class="p">(</span><span class="s2">&quot;Successfully logged in!&quot;</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="s2">&quot;Login successful&quot;</span><span class="p">)</span>
</span></span></code></pre></div></td></tr></table></div>
<p>Let's start with the simple changes before we dive into the internals of the new, improved <code>login</code> function.</p>
<h5 id="updated-settings">Updated <code>Settings</code></h5>
<p>First, we need to add some additional items to our <code>Settings</code> model. The <code>auth_url</code> will be the <code>base_url</code> for the Auth0
API. The <code>client_id</code> will be the unique ID we got while setting up Armasec with Auth0. The <code>audience</code> will also come
from the Auth0/Armasec setup. Let's go ahead and bind the values we need to our app's settings. Because we've already
provided some settings that we want to keep, we'll use the <code>update</code> sub-command instead of the <code>bind</code> sub-command:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>$ typerdrive-tutorial settings update \
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>  --auth-url=https://typerdrive-tutorial.us.auth0.com \
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>  --client-id=ahU6---------------------------- \
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>  --audience=typerdrive-tutorial
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a>╭─ Current settings ──────────────────────────────────────────────────────────────────────────────────────╮
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a>│                                                                                                         │
</span><span id="__span-30-8"><a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a>│     api-url -&gt; http://localhost:8000                                                                    │
</span><span id="__span-30-9"><a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a>│         env -&gt; dev                                                                                      │
</span><span id="__span-30-10"><a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a>│    auth-url -&gt; https://typerdrive-tutorial.us.auth0.com                                                 │
</span><span id="__span-30-11"><a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a>│   client-id -&gt; ahU6----------------------------                                                         │
</span><span id="__span-30-12"><a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a>│    audience -&gt; typerdrive-tutorial                                                                      │
</span><span id="__span-30-13"><a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a>│                                                                                                         │
</span><span id="__span-30-14"><a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a>╰─ saved to /home/dusktreader/.local/share/typerdrive-tutorial/settings.json ─────────────────────────────╯
</span></code></pre></div>
<h5 id="new-cache-sub-commands">New <code>cache</code> sub-commands</h5>
<p>Next, note that in the revised code, we're calling the <code>add_cache_subcommand()</code> function. This will add some commands to
our CLI that allow us to show the state of the cache and to clear it out if we need to:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>$ typerdrive-tutorial cache --help
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a> Usage: typerdrive-tutorial cache [OPTIONS] COMMAND [ARGS]...
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a> Manage cache for the app
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a>╭─ Options ────────────────────────────────────────────────────────────────────╮
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a>│ --help          Show this message and exit.                                  │
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a>╰──────────────────────────────────────────────────────────────────────────────╯
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a>╭─ Commands ───────────────────────────────────────────────────────────────────╮
</span><span id="__span-31-12"><a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a>│ clear                                                                        │
</span><span id="__span-31-13"><a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a>│ show                                                                         │
</span><span id="__span-31-14"><a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a>╰──────────────────────────────────────────────────────────────────────────────╯
</span></code></pre></div>
<h5 id="data-models">Data models</h5>
<p>Our communication with the Auth0 API involves three specific structures, and we've defined three Pydantic classes to
capture this. The <code>DeviceCodeRequest</code> model describes the data we need to send when requesting a login. The
<code>DeviceCodeResponse</code> model describes that data that will be returned by Auth0 once it's validated our request for a
code. Finally, The <code>TokenRequestData</code> describes the data we need to send to request an auth token after we've logged in.
<code>typerdrive</code> allows us to provide these models to our API requests to allow for easy serialization and deserialization
as well as validation that the values are correct.</p>
<p>As with the other features, there is an <code>@attach_cache()</code> decorator that binds the cache to the command context. Again,
we get access to the cache through a function argument of type <code>CacheManager</code>. The <code>CacheManager</code> provides methods to
store and retrieve data in the cache.</p>
<h5 id="the-new-login-function">The new <code>login()</code> function</h5>
<p>Before we review the changes in the <code>access()</code> command function, let's go through the internals of the new <code>login()</code>
command function to see how we secure an auth token.</p>
<p>At a high level, the function does the following:</p>
<ol>
<li>Request a device code from Auth0</li>
<li>Show a link to the user with the code embedded in it</li>
<li>Wait for the user to complete the login process</li>
<li>Retrieve the auth token from the API</li>
<li>Store it in the cache.</li>
</ol>
<p>Let's dig in a bit on each of those parts.</p>
<h6 id="1-requesting-a-device-code">1. Requesting a device code</h6>
<p>This is the code that fetches the device code:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>    <span class="n">device_code_data</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>        <span class="n">DeviceCodeResponse</span><span class="p">,</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>        <span class="n">auth</span><span class="o">.</span><span class="n">post_x</span><span class="p">(</span>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a>            <span class="s2">&quot;/oauth/device/code&quot;</span><span class="p">,</span>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a>            <span class="n">expected_status</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a>            <span class="n">body_obj</span><span class="o">=</span><span class="n">DeviceCodeRequest</span><span class="p">(</span>
</span><span id="__span-32-7"><a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a>                <span class="n">client_id</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">client_id</span><span class="p">,</span>
</span><span id="__span-32-8"><a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a>                <span class="n">grant_type</span><span class="o">=</span><span class="s2">&quot;client_credentials&quot;</span><span class="p">,</span>
</span><span id="__span-32-9"><a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a>                <span class="n">audience</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">audience</span><span class="p">,</span>
</span><span id="__span-32-10"><a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a>            <span class="p">),</span>
</span><span id="__span-32-11"><a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a>            <span class="n">response_model</span><span class="o">=</span><span class="n">DeviceCodeResponse</span><span class="p">,</span>
</span><span id="__span-32-12"><a id="__codelineno-32-12" name="__codelineno-32-12" href="#__codelineno-32-12"></a>        <span class="p">),</span>
</span><span id="__span-32-13"><a id="__codelineno-32-13" name="__codelineno-32-13" href="#__codelineno-32-13"></a>    <span class="p">)</span>
</span></code></pre></div>
<p>To get a device code from Auth0, we are posting a request to the <code>/oauth/device/code</code> endpoint and providing the app's
<code>client_id</code> and <code>audience</code>. We get those from the settings that we bound to the app. We will always use the
<code>grant_type="client_credentials"</code>, so that can be hard-coded. We are also taking advantage of the <code>TyperdriveClient</code>'s
ability to use a Pydantic model instance to provide the <code>POST</code> body here by passing a <code>DeviceCodeRequest</code> instance to
the <code>body_obj</code> parameter. Finally, we provide <code>DeviceCodeResponse</code> as the <code>response_model</code> for the <code>TyperdriveClient</code> to
unpack the response data into.</p>
<h6 id="2-showing-the-user-a-login-link">2. Showing the user a login link</h6>
<div class="language-python highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>    <span class="n">terminal_message</span><span class="p">(</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>        <span class="sa">f</span><span class="s2">&quot;Open </span><span class="si">{</span><span class="n">device_code_data</span><span class="o">.</span><span class="n">verification_uri_complete</span><span class="si">}</span><span class="s2"> in a browser to complete login&quot;</span><span class="p">,</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>        <span class="n">subject</span><span class="o">=</span><span class="s2">&quot;Complete login with browser&quot;</span><span class="p">,</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a>    <span class="p">)</span>
</span></code></pre></div>
<p>Because the response provided a verification URI for us, we can just show a terminal message to the user containing
that. The URI will contain the device code that we received from the first request. Most modern terminals allow you to
click on a link to open it in a browser. For mine, I just have to hold <code>ctrl</code> and click the link.</p>
<h6 id="3-5-wait-for-login-retrieve-auth-token-store-it-in-the-cache">3-5. Wait for login, retrieve auth token, store it in the cache</h6>
<p>The next 3 steps are wrapped up in the final bit of code:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Attempting to retrieve a token&quot;</span><span class="p">)</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>        <span class="n">response_data</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a>            <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a>            <span class="n">auth</span><span class="o">.</span><span class="n">post_x</span><span class="p">(</span>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a>                <span class="s2">&quot;/oauth/token&quot;</span><span class="p">,</span>
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a>                <span class="n">body_obj</span><span class="o">=</span><span class="n">TokenRequest</span><span class="p">(</span>
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a>                    <span class="n">grant_type</span><span class="o">=</span><span class="s2">&quot;urn:ietf:params:oauth:grant-type:device_code&quot;</span><span class="p">,</span>
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a>                    <span class="n">device_code</span><span class="o">=</span><span class="n">device_code_data</span><span class="o">.</span><span class="n">device_code</span><span class="p">,</span>
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a>                    <span class="n">client_id</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">client_id</span><span class="p">,</span>
</span><span id="__span-34-11"><a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a>                <span class="p">),</span>
</span><span id="__span-34-12"><a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a>            <span class="p">),</span>
</span><span id="__span-34-13"><a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a>        <span class="p">)</span>
</span><span id="__span-34-14"><a id="__codelineno-34-14" name="__codelineno-34-14" href="#__codelineno-34-14"></a>        <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">response_data</span><span class="p">:</span>
</span><span id="__span-34-15"><a id="__codelineno-34-15" name="__codelineno-34-15" href="#__codelineno-34-15"></a>            <span class="n">TutorialError</span><span class="o">.</span><span class="n">require_condition</span><span class="p">(</span>
</span><span id="__span-34-16"><a id="__codelineno-34-16" name="__codelineno-34-16" href="#__codelineno-34-16"></a>                <span class="n">response_data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;authorization_pending&quot;</span><span class="p">,</span>
</span><span id="__span-34-17"><a id="__codelineno-34-17" name="__codelineno-34-17" href="#__codelineno-34-17"></a>                <span class="sa">f</span><span class="s2">&quot;Failed to fetch a token with device_code </span><span class="si">{</span><span class="n">device_code_data</span><span class="o">.</span><span class="n">device_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="__span-34-18"><a id="__codelineno-34-18" name="__codelineno-34-18" href="#__codelineno-34-18"></a>            <span class="p">)</span>
</span><span id="__span-34-19"><a id="__codelineno-34-19" name="__codelineno-34-19" href="#__codelineno-34-19"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Didn&#39;t get a token yet. Trying again in </span><span class="si">{</span><span class="n">device_code_data</span><span class="o">.</span><span class="n">interval</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</span><span id="__span-34-20"><a id="__codelineno-34-20" name="__codelineno-34-20" href="#__codelineno-34-20"></a>            <span class="n">sleep</span><span class="p">(</span><span class="n">device_code_data</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span>
</span><span id="__span-34-21"><a id="__codelineno-34-21" name="__codelineno-34-21" href="#__codelineno-34-21"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-34-22"><a id="__codelineno-34-22" name="__codelineno-34-22" href="#__codelineno-34-22"></a>            <span class="k">with</span> <span class="n">TutorialError</span><span class="o">.</span><span class="n">handle_errors</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t extract token from response&quot;</span><span class="p">):</span>
</span><span id="__span-34-23"><a id="__codelineno-34-23" name="__codelineno-34-23" href="#__codelineno-34-23"></a>                <span class="n">access_token</span> <span class="o">=</span> <span class="n">response_data</span><span class="p">[</span><span class="s2">&quot;access_token&quot;</span><span class="p">]</span>
</span><span id="__span-34-24"><a id="__codelineno-34-24" name="__codelineno-34-24" href="#__codelineno-34-24"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received access token </span><span class="si">{</span><span class="n">access_token</span><span class="p">[:</span><span class="mi">32</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</span><span id="__span-34-25"><a id="__codelineno-34-25" name="__codelineno-34-25" href="#__codelineno-34-25"></a>            <span class="n">cache_manager</span><span class="o">.</span><span class="n">store_text</span><span class="p">(</span><span class="n">access_token</span><span class="p">,</span> <span class="s2">&quot;auth/access.token&quot;</span><span class="p">)</span>
</span><span id="__span-34-26"><a id="__codelineno-34-26" name="__codelineno-34-26" href="#__codelineno-34-26"></a>            <span class="k">break</span>
</span></code></pre></div>
<p>For this walkthrough, we're going to loop forever until a user completes the login process. For a real app, you probably
want the process to time out after some period of time. However, to keep things as simple as possible, we will just wait
forever.</p>
<p>We check to see if the user has logged in yet by requesting an access token from the Auth0 api at the <code>/oath/token</code>
endpoint. Again, we hard-code the <code>grant_type</code> and provide the <code>client_id</code> we configured in the app settings. The last
piece provided is the <code>device_code</code> we received in the first request.</p>
<p>This time, though, we do not provide a <code>response_model</code> or an expected status because we need to check the error data if
the API returns a non 200 status. Instead, the <code>post_x()</code> function will return a plain dictionary which we can pull the
<code>error</code> from. If this error is exactly "authorization_pending", then we know that the user hasn't yet completed the
login process but the login didn't fail either. If we see that specific error, we are just going to wait for a period
and try again. Helpfully, Auth0 (and any other OIDC provider) will provide an <code>interval</code> of time that we should wait
before requesting the auth token again to avoid flooding the API.</p>
<p>Finally, if we don't get an error response, it means the user has completed the login process. We can then extract the
the <code>access_token</code> from the response and store it in our cache. We use the cache key <code>auth/access.token</code>; we will
retrieve the token using this cache key when we need to access a secured endpoint.</p>
<p>Let's use one of our new <code>cache</code> sub-commands to see what our cache looks like now:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>╭─ Current cache ──────────────────────────────────────────────────────────────╮
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>│                                                                              │
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>│ 📂 /home/dusktreader/.cache/typerdrive-tutorial                              │
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a>│ └── 📂 auth                                                                  │
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a>│     └── 📄 access.token (684 Bytes)                                          │
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a>│                                                                              │
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a>╰─ Storing 684 Bytes in 1 files ───────────────────────────────────────────────╯
</span></code></pre></div>
<p>As you can see, we now have our access token stored in our cache for future use.</p>
<h5 id="accessing-the-secured-endpoint">Accessing the secured endpoint</h5>
<p>Now that we've seen how we get the access token and store it in the cache, let's check out how to use it to access the
secured endpoint.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>    <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>    <span class="k">if</span> <span class="n">endpoint</span> <span class="o">==</span> <span class="n">Endpoint</span><span class="o">.</span><span class="n">secured</span><span class="p">:</span>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading access token from cache&quot;</span><span class="p">)</span>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a>        <span class="n">access_token</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">load_text</span><span class="p">(</span><span class="s2">&quot;auth/access.token&quot;</span><span class="p">)</span>
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a>        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">access_token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
</span></code></pre></div>
<p>First, we will check if the user has requested to access the <code>secured</code> endpoint. If so, we retrieve the <code>access_token</code>
from our cache and add it into an <code>Authorization</code> header as a
<a href="https://swagger.io/docs/specification/v3_0/authentication/bearer-authentication/" target="blank">Bearer token</a>.</p>
<p>Once that's done, we can <em>finally</em> access our secured endpoint. Let's try it out!</p>
<h4 id="running-the-commands_6">Running the commands</h4>
<p>First, we need to log in using the <code>login</code> subcommand. When I open the link in my browser, I'm able to log in using my
google account. When I'm finished, the CLI lets me know I was successful:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>$ typerdrive-tutorial login
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>╭─ Complete login with browser ────────────────────────────────────────────────╮
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>│                                                                              │
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a>│   Open https://typerdrive-tutorial.us.auth0.com/activate?user_code=PLTZ-LXGC │
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a>│ in a browser to complete login                                               │
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a>│                                                                              │
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a>╰──────────────────────────────────────────────────────────────────────────────╯
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a>
</span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a>
</span><span id="__span-37-11"><a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a>╭─ Login successful ───────────────────────────────────────────────────────────╮
</span><span id="__span-37-12"><a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a>│                                                                              │
</span><span id="__span-37-13"><a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a>│   Successfully logged in!                                                    │
</span><span id="__span-37-14"><a id="__codelineno-37-14" name="__codelineno-37-14" href="#__codelineno-37-14"></a>│                                                                              │
</span><span id="__span-37-15"><a id="__codelineno-37-15" name="__codelineno-37-15" href="#__codelineno-37-15"></a>╰──────────────────────────────────────────────────────────────────────────────╯
</span></code></pre></div>
<p>In my browser, the login windows look like this:</p>
<p><img alt="auth0-login" src="../../../../images/2025-05-13--auth0.png" /></p>
<p>Now, let's see if we can access that <code>secured</code> endpoint:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a>$ typerdrive-tutorial access secured
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>╭─ Successfully connected to API ──────────────────────────────────────────────╮
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a>│                                                                              │
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a>│   Accessed secured endpoint!                                                 │
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a>│                                                                              │
</span><span id="__span-38-7"><a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a>╰──────────────────────────────────────────────────────────────────────────────╯
</span></code></pre></div>
<p>And there it is! We've successfully built up a CLI that can log into an OIDC auth provider, cache the access token, and
then access secured endpoints!</p>
<p>Now, it's worth mentioning that most CLIs of this type will also need to manage refresh tokens so that you don't have to
re-login every time your access token expires. However, that's an exercise I'm going to leave to the reader because this
walkthrough is already pretty long. The good news is that you can use the cache for the refresh token as well.</p>
<h2 id="conclusion">Conclusion</h2>
<p>While the example app we built here doesn't do a whole lot, it does tap into some really useful functionality provided
by <code>typerdrive</code>. The <code>typerdrive</code> package was designed from the ground up to make building CLIs that connect to secured
APIs easy and fun. The big idea is to let you get to the business of building out your business logic sooner rather than
setting up all the scaffolding needed for these type of CLIs.</p>
<p>I've gathered the patterns I've used to build these type of applications into a re-usable package that's friendly to
both the developer and to the end user. I hope you'll try out <code>typerdrive</code> and let me know what you think of it.</p>
<p>As always, feedback is very welcome as are Github issues and pull-requests.</p>
<p>Check out the <a href="https://github.com/dusktreader/typerdrive" target="blank"><code>typerdrive</code></a> Github repo and give the live
demo a try as well.</p>
<p>Thanks for reading!</p>







  
  




  



  <h2 id="__comments">Comments</h2>

  <script src="https://giscus.app/client.js"
          data-repo="dusktreader/blog"
          data-repo-id="R_kgDOOQ5SlA"
          data-category="General"
          data-category-id="DIC_kwDOOQ5SlM4Coli_"
          data-mapping="pathname"
          data-strict="0"
          data-reactions-enabled="1"
          data-emit-metadata="0"
          data-input-position="bottom"
          data-theme="preferred_color_scheme"
          data-lang="en"
          crossorigin="anonymous"
          async>
  </script>

  <script>
    var giscus = document.querySelector("script[src*=giscus]")

    // Set palette on initial load
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
      var theme = palette.color.scheme === "slate"
        ? "transparent_dark"
        : "light"

      // Instruct Giscus to set theme
      giscus.setAttribute("data-theme", theme)
    }

    // Register event handlers after documented loaded
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate"
            ? "transparent_dark"
            : "light"

          // Instruct Giscus to change theme
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
  </script>

      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
        
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../../../04/06/bootstrapping-python-projects-with-copier/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Bootstrapping Python projects with copier">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Bootstrapping Python projects with copier
              </div>
            </div>
          </a>
        
        
          
          <a href="../../../10/26/makefile-magic/" class="md-footer__link md-footer__link--next" aria-label="Next: Makefile magic">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Makefile magic
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.instant", "navigation.expand", "navigation.footer", "navigation.tracking", "navigation.footer", "content.code.copy"], "search": "../../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>